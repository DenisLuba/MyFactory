  # Материалы и поставщики

### FlyoutItems
```text
└── Материалы и поставщики
    ├── Материалы (Материалы — список, Карточка материала (просмотр), Карточка материала (редактирование))
    ├── Поставщики (Поставщики - список, Карточка поставщика)
    └── Заказы (Создание заказа поставщику)
```

## 📱 Экран  1. Материалы — список

ТЗ:
"1. На складе хранится несколько типов материалов (например с типом "ткань" хранятся 2 
наименования- "Ситец"-100 метров и, наименование "Бязь" 50 метров, а так же хранится тип 
"Фурнитура" с наименованием "Молния" 100шт и наименованием "Стропа" 100метров )

2. Остатки данных материалов находятся в таблице, куда так же занесены закупочная цена и 
наименование поставщика(их может быть несколько)"



Вкладка FlyoutItem "Материалы". Открываем ее. На странице - таблица со списком материалов. В 
первом столбце - тип материала, во втором - название, в третьем - остаток и рядом единицы 
(думаю, лучше в одном столбце будет количество и единицы, например, "100 м" или "5 шт.". Если 
пользователь нажимает на "ТИП МАТЕРИАЛА", то список будет упорядочен по типу материалов по 
алфавиту, если нажимает снова, то - в обратном порядке, аналогично - при нажатии на название 
материала. 
Есть поля - поиск по типу и поиск по материалу, которые будут сортировать список и отбирать 
подходящие строки при добавлении каждого знака в поле поиска. 
Есть кнопка "+" (или "Добавить") для добавления нового материала. 
Если нажать и удерживать материал, то появляются 2 иконки - редактировать и удалить. Если 
коротко нажать  на строку с материалом, то открывается карточка материала

⚠️ Важно:
**Остаток — это агрегированное значение**, его **нет напрямую** в `MATERIALS`.

Он считается как:

```
SUM(WAREHOUSE_MATERIALS.qty)
GROUP BY material_id
```

Пример DTO:

```csharp
MaterialListItemDto
{
    MaterialId
    MaterialTypeName
    MaterialName
    TotalQty
    UnitCode
}
```
---


**FlyoutItem:** `Материалы`

---

### 🔍 Панель фильтров

```
[ Поиск по типу материала ]   [ Поиск по материалу ]        [+ Добавить]
```

* поиск **реактивный**, фильтрация при каждом вводе символа
* сортировка не сбрасывает фильтр

---

### 📋 Таблица: Материалы

| ТИП МАТЕРИАЛА ⬍ | МАТЕРИАЛ ⬍ | ОСТАТОК |
| --------------- | ---------- | ------- |
| Ткань           | Ситец      | 100 м   |
| Ткань           | Бязь       | 50 м    |
| Фурнитура       | Молния     | 100 шт  |
| Фурнитура       | Стропа     | 100 м   |

**Поведение:**

* ⬍ — сортировка ↑ / ↓
* **Короткий тап по строке** → открывается карточка материала
* **Долгий тап по строке** → появляются иконки:

  ```
  ✏️ Редактировать   🗑 Удалить
  ```

### UI-возможности

* показать список материалов
* поиск по:

  * типу материала
  * названию
* сортировка:

  * по типу
  * по названию
* переход в карточку
* удаление
* добавление нового материала

---
### 🔎 Query: получить список материалов

### Application

```csharp
GetMaterialsQuery
```

без параметров
возвращает **всё, что можно показать этому пользователю**

```csharp
List<MaterialListItemDto>
```

---

### UI

* `ObservableCollection<MaterialVm>`
* `FilteredCollection`
* сортировка
* поиск
* группировка

```csharp
Materials = new ObservableCollection<MaterialVm>(data);

FilteredMaterials = Materials
    .Where(m => m.Name.Contains(SearchText))
    .OrderBy(...)
```
---

### НО: оставь задел

Спроектируй Query **так**, чтобы потом можно было расширить:

### Query (сейчас)

```csharp
public record GetMaterialsQuery(
    MaterialFilter? Filter = null
) : IRequest<IReadOnlyList<MaterialListItemDto>>;

public sealed class MaterialFilter
{
    public string? MaterialName { get; init; }
    public string? MaterialType { get; init; }

    public bool? IsActive { get; init; }
    public Guid? WarehouseId { get; init; }
}

MaterialListItemDto
{
    Guid Id
    string MaterialType
    string Name
    decimal TotalQty
    string UnitCode
}
```
**IsActive**

* скрывать архивные материалы

* чекбокс “Показывать неактивные”

**WarehouseId**

* потом: “показать остатки по складу”

* или “материалы на основном складе”


Даже если сейчас `filter = null`.

📌 **Не используй IQueryable наружу** — только DTO.

### Handler

* JOIN материалов
* GROUP BY по складам
* SUM qty
* map → DTO

```
if (!string.IsNullOrWhiteSpace(filter.MaterialName))
{
    query = query.Where(m =>
        m.Name.Contains(filter.MaterialName));
}

if (!string.IsNullOrWhiteSpace(filter.MaterialType))
{
    query = query.Where(m =>
        m.MaterialType.Name.Contains(filter.MaterialType));
}
```
---

```

📌 `TotalQty` — **агрегат из WarehouseMaterials**

---

### 🧠 Почему так

* UI **не знает**, откуда берётся остаток
* Domain **не отдаётся напрямую**
* сортировка и фильтрация — ответственность клиента, но оставим возможность фильтрации через Application с помощью фильтра MaterialFilter

---

### ➕ Command: создать материал

### Command

```csharp
CreateMaterialCommand
```

### DTO (вход)

```csharp
CreateMaterialDto
{
    string Name
    Guid MaterialTypeId
    Guid UnitId
    string? Color
}
```

### Handler делает

1. проверяет уникальность (если нужно)
2. создаёт `MaterialEntity`
3. сохраняет через репозиторий

---

### 🗑 Command: удалить материал

### Command

```csharp
DeactivateMaterialCommand
```

```csharp
Guid MaterialId
```

### Важно (бизнес-решение)

В Handler:

* либо **soft delete** (`IsActive = false`)
* либо проверка:

  * нет остатков
  * нет движений
  * нет закупок

📌 UI это **не решает**, только Application.


--- 

## 📱 Экран  2. Карточка материала (просмотр)

В карточке материала написан тип материала, название, количество и единицы. 

Ниже - строка "СКЛАДЫ" со стрелочкой-уголком вниз, при нажатии на которую открывается таблица 
со складами и количеством на каждом складе с единицами материала. 

Ниже - строка со стрелочкой вниз, при нажатии на которую разворачивается таблица историей цен и
поставщиков: таблица с ScrollView, в которой первый столбец - поставщик, второй столбец - цена,
третий столбец - дата (MATERIAL_SUPPLIERS_PRICES.created_at timestamp). Упорядочено по дате. 
При нажатии на заголовок столбца "Дата" происходит упорядочение по дате, при повторном нажатии 
- упорядочение в обратном порядке. То же самое при нажатии на заголовки "ПОСТАВЩИКИ" и "ЦЕНА" 
- (хотя цена - не обязательно). 
- 
Сверху страницы - кнопки: "РЕДАКТИРОВАТЬ", "УДАЛИТЬ", "ДОБАВИТЬ ЦЕНУ" и "НАЗАД" (возврат на 
страницу со списком материалов). 

Как с первой страницы (список материалов), так и со второй (карточка материала), при нажатии на
кнопку "РЕДАКТИРОВАТЬ" открывается редактируемая страница с карточкой материала(либо, если мы 
уже на "карточке материала", то просто Entry становятся редактируемыми), а также становится 
редактируемой таблица цен. Сверху будут кнопки "СОХРАНИТЬ" и "ОТМЕНИТЬ" вместо "РЕДАКТИРОВАТЬ",
"УДАЛИТЬ". При нажатии на кнопку "УДАЛИТЬ", через окно с предупреждением и подтверждением 
удаляется материал со всей его историей из списка материалов. При нажатии кнопки "ДОБАВИТЬ ЦЕНУ"
в таблице цен на странице карточки материала добавляется еще одна строка сверху с активными для
записи полями. Кнопка "ДОБАВИТЬ ЦЕНУ" исчезает, а на ее месте становятся видимыми и доступными 
кнопки "СОХРАНИТЬ" и "ОТМЕНИТЬ". На странице с карточкой товара в таблице цен, если нажать на 
поставщика, то происходит переход на страницу с поставщиком. 

---

```
← Назад
────────────────────────────
Материал:      Ситец
Тип:           Ткань
Цвет:          —
Остаток:       100 м
────────────────────────────
[ РЕДАКТИРОВАТЬ ] [ УДАЛИТЬ ] [ ДОБАВИТЬ ЦЕНУ ]
```


👉 Источник данных:

| Колонка UI | Откуда                              |
| ---------- | ----------------------------------- |
| Тип        | MATERIAL_TYPES                      |
| Материал   | MATERIALS                           |
| Кол-во     | MATERIAL_PURCHASE_ITEMS.qty         |
| Цена       | MATERIAL_PURCHASE_ITEMS.unit_price  |
| Дата       | MATERIAL_PURCHASE_ORDERS.order_date |
---

### 🏬 Секция: Склады ▼

(свернуто по умолчанию)

```
▶ Склады
```

(развёрнуто)

| СКЛАД    | КОЛ-ВО |
| -------- | ------ |
| Основной | 70 м   |
| Цех №1   | 30 м   |

```
Склад | Количество
```

Источник:

* `WAREHOUSE_MATERIALS`
* `WAREHOUSES`
* `UNITS`

---

### 💰 Секция: Поставщики / история закупок ▼

(ScrollView)

| ПОСТАВЩИК ⬍ | КОЛ-ВО | ЦЕНА | ДАТА ⬍     |
| ----------- | ------ | ---- | ---------- |
| Текстиль+   | 100 м  | 120  | 12.01.2024 |
| Иванов ИП   | 50 м   | 115  | 03.11.2023 |

* сортировка по любому столбцу
* **клик по поставщику** → переход в карточку поставщика


### 🔎 Query: получить материал целиком

### Query

```csharp
GetMaterialDetailsQuery
```

### Возвращаемый DTO

```csharp
MaterialDetailsDto
{
    Guid Id
    string Name
    string MaterialType
    string UnitCode
    string? Color
    decimal TotalQty

    List<WarehouseQtyDto> Warehouses
    List<MaterialPurchaseHistoryDto> PurchaseHistory
}
```
---


## 📱 Экран  3. Карточка материала (редактирование)

```
← Назад
────────────────────────────
Материал:   [ Ситец        ]
Тип:        [ Ткань   ▼    ]
Цвет:       [              ]
────────────────────────────
[ СОХРАНИТЬ ] [ ОТМЕНИТЬ ]
```

### История закупок — редактируемая

| ПОСТАВЩИК | КОЛ-ВО | ЦЕНА | ДАТА |
| --------- | ------ | ---- | ---- |
| [ ▼ ]     | [  ]   | [  ] | [  ] |

* строка добавляется сверху
* кнопка **«Добавить цену»** скрыта
* данные сохраняются через `MaterialPurchaseOrder`

Источник:

* `MATERIAL_PURCHASE_ORDERS`
* `SUPPLIERS`

👉 Источник данных:

| Колонка UI | Откуда                              |
| ---------- | ----------------------------------- |
| Тип        | MATERIAL_TYPES                      |
| Материал   | MATERIALS                           |
| Кол-во     | MATERIAL_PURCHASE_ITEMS.qty         |
| Цена       | MATERIAL_PURCHASE_ITEMS.unit_price  |
| Дата       | MATERIAL_PURCHASE_ORDERS.order_date |

---
### ✏️ Command: обновить материал

```csharp
UpdateMaterialCommand
```

```csharp
Guid MaterialId
string Name
Guid MaterialTypeId
Guid UnitId
string? Color
```

Handler:

* загружает `MaterialEntity`
* изменяет поля
* сохраняет
---

### Под-DTO

```csharp
WarehouseQtyDto
{
    Guid WarehouseId
    string WarehouseName
    decimal Qty
    string UnitCode
}
```

```csharp
MaterialPurchaseHistoryDto
{
    Guid SupplierId
    string SupplierName
    decimal Qty
    decimal UnitPrice
    DateTime PurchaseDate
}
```

📌 История берётся из `MaterialPurchaseOrderItem`
---


## 📱 Экран  4. Карточка поставщика

На странице поставщика в первой строке жирным шрифтом название поставщика (или его имя), ниже - описание (или ничего), еще ниже - реквизиты и контакты. 
Ниже история материалов и цен. 1 столбец - тип материала, 2 - название материала, 3 - сколько было куплено единиц (например, "100 м"), 4 - цена за единицу, 5 - дата покупки. Есть кнопки "РЕДАКТИРОВАТЬ" (все становится редактируемым), "ДОБАВИТЬ ЗАКУПКУ" (добавляется пустая редактируемая строка в историю материалов и цен), "СОЗДАТЬ ЗАКАЗ" (открывается страница для создания заказа материала). 

---

```
← Назад
────────────────────────────
ТЕКСТИЛЬ+
────────────────────────────
(описание, реквизиты, контакты)
────────────────────────────
[ РЕДАКТИРОВАТЬ ] [ ДОБАВИТЬ ЗАКУПКУ ] [ СОЗДАТЬ ЗАКАЗ ]
```

---

```csharp
GetSupplierDetailsQuery
```

### DTO

```csharp
SupplierDetailsDto
{
    Guid Id
    string Name
    string? Description

    List<SupplierPurchaseHistoryDto> Purchases
}
```

```csharp
SupplierPurchaseHistoryDto
{
    string MaterialType
    string MaterialName
    decimal Qty
    decimal UnitPrice
    DateTime Date
}
```
---

### 📦 История закупок у поставщика

| ТИП       | МАТЕРИАЛ | КОЛ-ВО | ЦЕНА | ДАТА       |
| --------- | -------- | ------ | ---- | ---------- |
| Ткань     | Ситец    | 100 м  | 120  | 12.01.2024 |
| Фурнитура | Молния   | 50 шт  | 15   | 05.12.2023 |

---


## 📱 Экран  5. Создание заказа поставщику

ТЗ:
"6.1. Сначала происходит проверка наличия материалов на складах для пошива - если материалов 
	не хватает - формируется ведомость материалов для заказа поставщику."

При создании заказа открывается страница для создания заказа материала, на которой будет 
выпадающий список поставщиков с поиском (Entry с поиском, а справа стрелка вниз и выпадает 
список поставщиков) (активный поставщик - тот, с чьей страницы мы перешли).

Рядом - выпадающий список типов материала с поиском.

Рядом - выпадающий список материалов с поиском. 

Рядом Entry для заполнения количества и Entry для заполнения цены (но она по умолчанию
подсчитывается, исходя из последней цены поставщика за этот материал, умноженная на количество, 
прописывается, но не в виде placeholder, а текстом, который можно отредактировать). 

Ниже можно добавить еще материал для заказа у этого поставщика при нажатии на "+" (добавить 
материал). 

Ниже - кнопка, например, "СОХРАНИТЬ" (сохраняется файл через FilePicker) и можно 
добавить кнопку "ПЕЧАТЬ" (если Mac или Windows). 
 
---

```
← Назад                                                                [+]
──────────────────────────────────────────────────────────────────────────
Поставщик        Тип             Материал        Количество    Цена
[ Текстиль+ ▼ ]  [ Ткань    ▼ ]  [ Ситец    ▼ ]  [ 100      ]  [ 12000   ] 
──────────────────────────────────────────────────────────────────────────
[ СОХРАНИТЬ ]   [ ПЕЧАТЬ ]
```

* цена **автозаполняется** из последней закупки
* можно вручную изменить
* при сохранении:

  * создаётся `MaterialPurchaseOrder`
  * создаётся `MaterialPurchaseOrderItem`
  * открывается FilePicker

**Добавить цену / закупку**

> Важно: **мы не “добавляем цену”**,
> мы **создаём закупку**

---

### ➕ Command: создать закупку материала

```csharp
CreateMaterialPurchaseOrderCommand
```

### DTO

```csharp
CreateMaterialPurchaseOrderCommandDto
{
    Guid SupplierId
    DateTime OrderDate
    List<PurchaseItemDto> Items
}
```

```csharp
PurchaseOrderItemDto
{
    Guid MaterialId
    decimal Qty
    decimal UnitPrice
}
```

📌 **одна команда = один заказ**, даже если UI создаёт его из карточки материала
---

### Все команды для создания заказа:

* CreateMaterialPurchaseOrderCommand
* AddMaterialPurchaseOrderItemCommand
* ConfirmMaterialPurchaseOrderCommand
* ReceiveMaterialPurchaseOrderCommand

### Как закупка выглядит в реальной жизни (даже на маленьком производстве)

Почти всегда процесс такой:

1. Создали черновик заказа
2. Добавили материалы (1…N)
3. Проверили
4. Подтвердили заказ
5. Материалы приехали (полностью или частично)
6. Материалы попали на склад

👉 Это **разные бизнес-состояния**, а значит — **разные команды**

---

### Разберём каждую команду

---

### 🟢 1. CreateMaterialPurchaseOrderCommand

### Что делает

Создаёт **пустой заказ (черновик)**

```text
Supplier = X
Date = Today
Status = New
Items = []
```

### Когда вызывается

* пользователь нажал **«Создать заказ»**
* заказ ещё **можно редактировать**

### Почему это отдельная команда

* заказ может быть сохранён **без позиций**
* заказ может быть отменён
* заказ может лежать в черновиках

---

### 🟡 2. AddMaterialPurchaseOrderItemCommand

### Что делает

Добавляет **одну строку** в заказ:

```text
Материал
Количество
Цена
```

### Когда вызывается

* пользователь нажал «+»
* пользователь добавляет материалы **по одному**
* пользователь редактирует заказ

### Почему не в одной команде

Потому что:

* пользователь может добавить 10 материалов
* может удалить строку
* может изменить количество

Если всё засунуть в `CreateMaterialPurchaseOrderCommand`:

* сложная валидация
* сложный DTO
* сложно редактировать

---

### 🟠 3. ConfirmMaterialPurchaseOrderCommand

### Что делает

Переводит заказ из:

```text
New → Confirmed
```

### Когда вызывается

* пользователь нажал **«Подтвердить заказ»**
* заказ ушёл поставщику (email / печать / PDF)

### Что меняется

* ❌ нельзя редактировать позиции
* ❌ нельзя менять цены
* ✔️ заказ считается «официальным»

### Почему это отдельная команда

Это **бизнес-граница**:

* до подтверждения — черновик
* после — обязательство

---

### 🔵 4. ReceiveMaterialPurchaseOrderCommand

### Что делает

Фиксирует факт получения материалов:

* заказ → `Received`
* создаёт `InventoryMovement`
* увеличивает остатки на складе

### Когда вызывается

* материалы реально приехали
* кладовщик нажал «Принять»

### Почему нельзя объединять с Confirm

Потому что:

* заказ подтверждают **сегодня**
* материалы приезжают **через неделю**
* могут приехать **частично**

---

### Как это выглядит в UI (чтобы было наглядно)

```text
[Создать заказ]
   ↓
[Редактирование]
   ↓
[Подтвердить]
   ↓
[Ожидание поставки]
   ↓
[Принять на склад]
```

Каждая стрелка = **одна команда**

---

### Связь с твоим Domain (ты уже всё подготовил)

Ты уже сделал идеально:

```csharp
EnsureEditable()
Confirm()
Receive()
Cancel()
```

Application просто:

* вызывает методы Domain
* сохраняет через репозиторий

---

### Итог коротко

| Команда | Зачем              |
| ------- | ------------------ |
| Create  | создать черновик   |
| AddItem | управлять строками |
| Confirm | бизнес-граница     |
| Receive | движение склада    |

---


## 📱 Экран 6. Поставщики — список

При тапе на вкладку "Поставщики" открывается список поставщиков с возможностью реактивного 
поиска поставщиков, с кнопкой "добавить" поставщика. Ниже - список поставщиков. При коротком 
тапе на поставщика открывается карточка поставщика. При длинном тапе - появляются кнопки 
"Редактировать" и "Удалить".

**FlyoutItem:** `Поставщики`

```
[ Поиск поставщика ]        [+ Добавить]
```

| ПОСТАВЩИК |
| --------- |
| Текстиль+ |
| Иванов ИП |

* короткий тап → карточка поставщика
* долгий тап → редактировать / удалить

---

### 🧠 Архитектурный итог


| UI действие | Domain                      |
| ----------- | --------------------------- |
| История цен | `MaterialPurchaseOrderItem` |
| Заказ       | `MaterialPurchaseOrder`     |
| Остатки     | `WarehouseMaterial`         |
| Поставщик   | `SupplierEntity`            |

---
### 🧩 Итог: соответствие UI → Application

| UI                 | Application                     |
| ------------------ | ------------------------------- |
| Список материалов  | `GetMaterialsQuery`             |
| Карточка материала | `GetMaterialDetailsQuery`       |
| Добавить материал  | `CreateMaterialCommand`         |
| Редактировать      | `UpdateMaterialCommand`         |
| Удалить            | `DeactivateMaterialCommand`         |
| Добавить цену      | `CreateMaterialPurchaseOrderCommand` |
| Поставщик          | `GetSupplierDetailsQuery`       |
| Добавить поставщика | `CreateSupplierCommand`              |
| Редактировать       | `UpdateSupplierCommand`              |
| Деактивировать      | `DeactivateSupplierCommand`          |
| Создать заказ       | `CreateMaterialPurchaseOrderCommand` |


МАТЕРИАЛЫ
- GetMaterialsQuery
- GetMaterialDetailsQuery
- CreateMaterialCommand
- UpdateMaterialCommand
- DeactivateMaterialCommand

ЗАКУПКИ
- CreateMaterialPurchaseOrderCommand
- AddMaterialPurchaseOrderItemCommand
- ConfirmMaterialPurchaseOrderCommand
- ReceiveMaterialPurchaseOrderCommand

ПОСТАВЩИКИ
- GetSupplierDetailsQuery
- CreateSupplierCommand
- UpdateSupplierCommand
- DeactivateSupplierCommand


---

# Товары

## FlyoutItems
    
```text
└── Товары (Товары — список, Карточка товара, Редактирование товара)
```

## 📱 Экран 7. «Товары» (список)

ТЗ: "3. Существует таблица Товаров, каждый товар состоит из каких то материалов например Ситец и 
Молния, то есть на каждый товар есть спецификация в которой можно увидеть себестоимость 
материалов из которых состоит каждое конкретное изделие
Кроме того на каждое изделие дополнительно ложатся 4 показателя - "Плановые цеховые расходы" 
(устанавливаются вручную, для каждого цеха свои) , "Стоимость раскроя 1 единицы" 
(устанавливаются вручную, для каждого цеха свои), "Стоимость пошива 1единицы" (Устанавливаются 
вручную, для каждого цеха свои), Стоимость упаковки (устанавливаются вручную, для каждого цеха 
свои) 
Так же, у каждого изделия есть такой показатель как "План пошива в смену" (будет использоваться 
позже), например "2,5" значит два с половиной изделия швея должна шить в час."

### 📱 FlyoutItem: **Товары**

```text
┌────────────────────────────────────────────┐
│ 🔍 Поиск [___________]   [+ Добавить]     │
├────────────────────────────────────────────┤
│ Название       │ Категория │ Себестоимость │
├────────────────────────────────────────────┤
│ Фартук №1      │ Одежда    │ 520 ₽         │
│ Сумка тканевая │ Аксессуар │ 310 ₽         │
│ Чехол          │ Прочее    │ 180 ₽         │
└────────────────────────────────────────────┘
```

### Что видно сразу

* название товара
* категория (если будет)
* **расчётная себестоимость** (очень важно!)

### UX

* сортировка по названию / себестоимости
* поиск по названию
* короткий тап → карточка товара
* долгий тап → ✏️ редактировать / 🗑 удалить

---

### Application

### Query

```csharp
GetProductsQuery
→ ProductListItemDto
{
    Guid Id
    string Name
    decimal CostPrice
}
```

---

## 📱 Экран  8. «Карточка товара»

```text
← Назад      ✏️ Редактировать   🗑 Удалить
────────────────────────────────────────────
🧵 Фартук №1

План пошива в смену: 2.5 шт/час

Себестоимость:
- Материалы: 320 ₽
- Производство: 200 ₽
────────────────────────────────────────────
▼ СПЕЦИФИКАЦИЯ (BOM)
Материал     Количество   Цена
Ситец        1.2 м        180 ₽
Молния       1 шт         40 ₽
──────────────────────────────
ИТОГО:                   220 ₽

────────────────────────────────────────────
▼ ПРОИЗВОДСТВЕННЫЕ ЗАТРАТЫ (по цехам)
Цех        Раскрой  Пошив  Упаковка  Прочее   ВСЕГО
Швейный    50 ₽     120 ₽  30 ₽       20 ₽     220 ₽
────────────────────────────────────────────
▼ ОСТАТКИ НА СКЛАДАХ
Склад          Доступно
Основной       42 шт
```
---

### Что здесь важно

### 🔹 Спецификация (BOM)

* это **ProductMaterialEntity**
* показывает материалы и нормы

### 🔹 Производственные затраты

* **по цехам**
* задаются вручную
* участвуют в себестоимости

### 🔹 Остатки

* не материалы
* а **сколько изделий можно произвести**
* рассчитывается по минимальному материалу

---

### Application

### Query

```csharp
GetProductDetailsQuery
```

DTO включает:

* Product
* BOM
* ProductionCosts
* CalculatedAvailability

---

## 📱 Экран  9. «Редактирование товара»

```text
← Отмена        💾 Сохранить
────────────────────────────────────────────
Название: [Фартук №1]
План/час: [2.5]

▼ СПЕЦИФИКАЦИЯ
Материал   Количество   [+]
Ситец      1.2 м
Молния     1 шт.

▼ ПРОИЗВОДСТВЕННЫЕ ЗАТРАТЫ
Цех        Раскрой   Пошив   Упаковка   Прочее
Швейный    [50]      [120]   [30]       [20]
```

### UX

* добавление материала через dropdown с поиском
* норма — decimal
* цены подтягиваются автоматически
* себестоимость пересчитывается **онлайн**

---

### Application

### Commands

```csharp
CreateProductCommand
UpdateProductCommand
AddProductMaterialCommand
UpdateProductMaterialCommand
SetProductProductionCostsCommand
```

---

# Склады 

### FlyoutItems
```text
└── Склады (Список складов, Остатки склада)
```

## 📱 Экран  10. Список складов

ТЗ:
"4. На производстве есть несколько складов, один из них основной."

```text
┌────────────────────────────────────────────┐
│ 🏬 Склады                    [+ Добавить] │
├────────────────────────────────────────────┤
│ Название            │ Тип                 │
├────────────────────────────────────────────┤
│ Основной            │ Материалы           │
│ Цех №1              │ Производственный    │
│ Упаковка            │ Вспомогательный     │
└────────────────────────────────────────────┘
```

### UX

* 🔼🔽 сортировка по названию
* короткий тап → **остатки склада**
* долгий тап →

  * ✏️ Редактировать
  * 🗑 Удалить (деактивация)

### Кнопка «Добавить»

Добавляет **пустую строку в таблицу**:

```text
[__________]  [▼ Тип]
```

После подтверждения → `CreateWarehouseCommand`

---

### Application

### Query

```csharp
GetWarehousesQuery
→ WarehouseListItemDto
{
    Guid Id
    string Name
    WarehouseType Type
    bool IsActive
}
```

### Commands

```csharp
CreateWarehouseCommand
UpdateWarehouseCommand
DeactivateWarehouseCommand
```

---

## 📱 Экран  11. Остатки склада

ТЗ:
"С основного склада готовой продукции готовые изделия могут перемещаться на другие склады готовой
продукции и оттуда отгружаться клиентам."

(открывается по короткому тапу)

```text
← Назад          🏬 Основной склад        [+ Добавить]
──────────────────────────────────
Материал / Товар        Количество
Ситец                   100 м
Молния                  45 шт

[Переместить]
```

либо (в зависимости от типа склада)
```
← Назад          🏬 Склад ГП
──────────────────────────────────
Товар                   Количество
Фартук                  20 шт
Рубашка                 15 шт

[Переместить]
```

👉 UI-компонент может быть один, меняется:

* заголовок

* источник данных

* команды

### UX

* 🔼🔽 сортировка по материалу
* короткий тап → **карточка материала**
* долгий тап →

  * ✏️ Редактировать (количество)
  * 🗑 Удалить (убрать материал со склада)

### «Добавить»

Добавляется строка:

```text
[▼ Материал]   [ 0 ]
```

✔ без модалок
✔ быстро
✔ как в Excel

---

### Application

### Query

```csharp
GetWarehouseStockQuery
→ WarehouseStockItemDto
{
    Guid MaterialId
    string MaterialName
    decimal Qty
    string UnitCode
}
```

### Commands

```csharp
AddMaterialToWarehouseCommand
UpdateWarehouseMaterialQtyCommand
RemoveMaterialFromWarehouseCommand
```

> ⚠️ Реально это будет через `InventoryMovement (Adjustment)`,
> но **для UI мы можем абстрагировать это одной командой** — правильно.

---

### Важный UX-момент 

**Удалить материал из списка материалов в товаре**

Ты тут, скорее всего, **оговорился**, но я поясню:

* на **складе** → удаляем **связь склад–материал**
* в **товаре** → удаляем **материал из спецификации**

Это:

* разные экраны
* разные команды
* разная логика

Ты всё правильно чувствуешь, просто важно это **не смешать в коде**.

---

### Как это ляжет на Application слой (коротко)

### Склады

```text
GetWarehousesQuery
CreateWarehouseCommand
UpdateWarehouseCommand
DeactivateWarehouseCommand
```

### Остатки

```text
GetWarehouseStockQuery
AddMaterialToWarehouseCommand
UpdateWarehouseMaterialQtyCommand
```

### Материалы

```text
GetMaterialsQuery
GetMaterialDetailsQuery
```
---

### 📦 UX: Перемещение материалов / товаров

### Исходный экран: Остатки склада

```text
Материал        Количество
☐ Ситец          100 м
☐ Молния         45 шт
☐ Стропа         30 м

[ Переместить ]
```

---

### После нажатия «Переместить»

```text
🔄 Перемещение
Выберите материал или товар
```

* строки становятся **выбираемыми**
* можно выбрать **несколько**

```text
☑ Ситец          [ 50 ] м
☑ Молния         [ 10 ] шт
☐ Стропа         30 м
```

👉 количество **редактируемое**, но:

* по умолчанию = текущее
* нельзя больше, чем есть

---

### Выбор назначения

```text
Выберите куда:
[ ▼ Склад упаковки ]
```

(фильтруется по совместимому типу склада)

---

### Подтверждение

```text
[ Переместить ]
```

или

```text
[ ОК ]
```

После:

* возврат на список
* остатки обновлены

✔ без лишних окон
✔ массовые операции
✔ логично и быстро

---

### ВАЖНО: как это реализуется в Domain

### ❌ НЕ делаем

* `TransferMaterial()` в `WarehouseMaterialEntity`
* `MoveProduct()` в `WarehouseProductEntity`

❗ Потому что **перемещение — это событие, а не состояние**

---

### ✅ Правильно 

Через **InventoryMovement**

### Для материалов

```text
InventoryMovement
- type = Transfer
- from_warehouse_id
- to_warehouse_id
- created_by

InventoryMovementItems
- material_id
- qty
```

### Для товаров

```text
FinishedGoodsMovement
- from_warehouse_id
- to_warehouse_id

FinishedGoodsMovementItems
- product_id
- qty
```

👉 UI «Переместить» просто **создаёт движение**

---

### Application слой: какие команды нужны

### 🔹 Заполнение экрана

```csharp
GetWarehouseStockQuery
```

Возвращает **или материалы, или товары**, в зависимости от склада:

```csharp
WarehouseStockItemDto
{
    Guid ItemId        // MaterialId | ProductId
    string Name
    decimal Qty
    string UnitCode
}
```

---

### 🔹 Перемещение

### Материалы

```csharp
TransferMaterialsCommand
{
    Guid FromWarehouseId
    Guid ToWarehouseId
    List<TransferItemDto>
}

TransferItemDto
{
    Guid MaterialId
    decimal Qty
}
```

### Товары

```csharp
TransferProductsCommand
{
    Guid FromWarehouseId
    Guid ToWarehouseId
    List<TransferItemDto>
}
```

> ⚠️ Можно сделать **одну команду** с enum `ItemType`,
> но на старте **2 команды проще и чище**.

---

# Связь с Domain 

| Domain                      | Используется |
| --------------------------- | ------------ |
| ProductEntity               | карточка     |
| ProductMaterialEntity       | BOM          |
| ProductDepartmentCostEntity | затраты      |
| InventoryMovement           | передача     |
| WarehouseMaterial           | остатки      |

---

# Заказы

### FlyoutItems
```text
└── Заказы
    ├── Заказы (Заказы — список, Карточка заказа)
    └── Заказчики (Заказчики — список, Карточка заказчика)
```

## 📱 Экран  12. Заказы

**Источник данных:**

* `SALES_ORDERS`
* `CUSTOMERS`

---

### 📋 Таблица заказов

```text
┌────────────────────────────────────────────────────────────┐
│ Заказы клиентов                                 [+ Добавить] │
├────────────────────────────────────────────────────────────┤
│ № заказа │ Заказчик        │ Дата       │ Статус           │
├──────────┼─────────────────┼────────────┼──────────────────┤
│ SO-0001  │ ООО Ромашка ↓↑  │ 12.03.2025 │ Новый            │
│ SO-0002  │ ИП Иванов       │ 13.03.2025 │ В работе         │
│ SO-0003  │ ООО Текстиль    │ 14.03.2025 │ Завершен         │
└────────────────────────────────────────────────────────────┘
```

### 🔍 Возможности

* 🔼🔽 сортировка:

  * по заказчику
  * по номеру заказа
* 👆 короткое нажатие → **карточка заказа**
* 👆⏱ длительное нажатие →

  * ✏️ **Редактировать**
  * 🗑 **Удалить**

---

### ➕ Добавить заказ

При нажатии **[+ Добавить]**:

```text
Создание заказа
────────────────────────────
Заказчик:   [ ▼ Поиск заказчика ]
Номер:      SO-0004 (авто)
Дата:       18.03.2025  (изменяемая)
Статус:     Новый

[ Создать ]
[ Отмена ]
```
### 🧾 Заказы клиентов — Application слой

---

### 📋 Список заказов

### 🔍 Запрос

```csharp
GetSalesOrdersQuery
```

**Возвращает:**

```csharp
SalesOrderListItemDto
{
    Guid Id;
    string OrderNumber;
    string CustomerName;
    DateTime OrderDate;
    SalesOrderStatus Status;
}
```

📌 Используется:

* таблица заказов
* сортировка (клиент, номер, дата)
* фильтры (позже)

---
### ➕ Создание заказа

### 🧾 Команда

```csharp
CreateSalesOrderCommand
```

```csharp
{
    Guid CustomerId;
    DateTime OrderDate;
}
```

📌 Логика:

* номер заказа генерируется внутри
* статус = `New`
* created_by / created_at — внутри
---

## 📱 Экран  13. Карточка заказа 

### 🧾 Заголовок заказа

```text
← Назад                         Заказ SO-0001
────────────────────────────────────────────────
Заказчик:   ООО Ромашка
Дата:       12.03.2025
Статус:     В работе
Создал:     Иван Петров
```

[Производство]

---

### 📦 Товары в заказе 

```text
┌──────────────────────────────────────────────┐
│ Товары в заказе                    [+ Добавить] │
├──────────────────────────────────────────────┤
│ Товар ↓↑              │ Количество │
├───────────────────────┼────────────┤
│ Фартук                │ 10 шт       │
│ Рубашка               │ 20 шт       │
└──────────────────────────────────────────────┘
```

---

### 📱 Отгружено по заказу 

```text
┌────────────────────────────────────────────────────────────┐
│ Отгрузки по заказу                                         │
├────────────────────────────────────────────────────────────┤
│ Изделие │ ПЗ │ Склад            │ Кол-во │ Дата           │
├─────────┼────┼──────────────────┼────────┼────────────────┤
│ Фартук  │ PZ-12 │ Склад отгрузки │ 6 шт   │ 14.09.2025     │
│ Фартук  │ PZ-12 │ Склад отгрузки │ 4 шт   │ 15.09.2025     │
└─────────┴────┴──────────────────┴────────┴────────────────┘
```

### UX-поведение

* 👆 клик по **ПЗ** → карточка производственного заказа
* 👆 клик по **складу** → карточка склада
* итоги можно показать ниже:

  ```text
  Итого отгружено: 10 из 10 ✔
  ```

---


Кнопка [Производство]: переход на страницу создания производственного заказа (ниже)

### 🔍 Запрос

```csharp
GetSalesOrderDetailsQuery
```

```csharp
{
    Guid OrderId;
}
```

```csharp
GetSalesOrderShipmentsQuery
```

```csharp
{
    Guid SalesOrderId;
}
```

### DTO

```csharp
SalesOrderShipmentDto
{
    Guid Id;
    string ProductName;
    string ProductionOrderNumber;
    string WarehouseName;
    decimal Qty;
    DateTime ShippedAt;
}
```

Источник данных:

* `INVENTORY_MOVEMENTS`
* `INVENTORY_MOVEMENT_ITEMS`
* `PRODUCTION_ORDERS`
* `WAREHOUSES`
* `PRODUCTS`

---


**Возвращает:**

```csharp
SalesOrderDetailsDto
{
    Guid Id;
    string OrderNumber;
    DateTime OrderDate;
    SalesOrderStatus Status;

    CustomerDto Customer;

    IReadOnlyList<SalesOrderItemDto> Items;
}
```
---

### ✏️ Редактирование заказа (шапка)

### 🧾 Команда

```csharp
UpdateSalesOrderCommand
```

```csharp
{
    Guid OrderId;
    Guid CustomerId;
    DateTime OrderDate;
}
```

📌 Правило:

* только если `Status == New`

---

### 🗑 Удаление заказа

### 🧾 Команда

```csharp
DeleteSalesOrderCommand
```

```csharp
{
    Guid OrderId;
}
```

📌 Правило:

* только `New`
* soft delete или hard delete — твой выбор (я бы soft)

---

### 📦 Работа с товарами в заказе

### Взаимодействие

* 👆 короткое нажатие → переход на страницу товара
* 👆⏱ длительное нажатие →

  * ✏️ **Редактировать строку**
  * 🗑 **Удалить строку**

---

### ➕ Добавление товара в заказ

```text
Добавить товар
────────────────────────────
Товар:       [ 🔍 Поиск товара ▼ ]
Количество:  [ 10 ]

[ Добавить ]
[ Отмена ]
```

### ➕ Добавить товар

```csharp
AddSalesOrderItemCommand
```

```csharp
{
    Guid OrderId;
    Guid ProductId;
    decimal Qty;
}
```

---

### ✏️ Редактирование заказа

Кнопка **[Редактировать]** в шапке:

* заказчик → выпадающий список с поиском
* дата → редактируемая
* строки товаров → редактируемые

Верхние кнопки меняются:

```text
[ Сохранить ]   [ Отменить ]
```
### ✏️ Редактировать товар

```csharp
UpdateSalesOrderItemCommand
```

```csharp
{
    Guid OrderItemId;
    decimal Qty;
}
```
---

### 🗑 Удаление заказа

* подтверждение
* удаляется заказ + все позиции
* **только если статус = Новый**

---

### Статус заказа — пересчёт

### Где считать?

В Application (Query / Projection), **не хранить в БД**.

```text
Если Σ shipped >= Σ ordered → Completed
Если > 0 и < ordered → InProgress
Если 0 → New
```

---

### 🗑 Удалить товар

```csharp
RemoveSalesOrderItemCommand
```

```csharp
{
    Guid OrderItemId;
}
```

📌 Все три:

* разрешены **только если заказ = New**

---

### 🔄 Управление статусом заказа

(не в UI сразу, но нужно архитектурно)

### ▶️ Запуск в работу - кнопка [Производство]
**Кнопка [Производство] — логика**

| Ситуация      | Поведение                         |
| ------------- | --------------------------------- |
| Нет ПЗ        | открыть создание ПЗ               |
| Есть ПЗ       | открыть список ПЗ по этому заказу |
| Все отгружено | кнопка disabled                   |

```csharp
StartSalesOrderCommand
```

```csharp
{
    Guid OrderId;
}
```

📌 Перевод:
`New → InProgress`

---

### ✅ Завершение

```csharp
CompleteSalesOrderCommand
```

```csharp
{
    Guid OrderId;
}
```

---

### ❌ Отмена

```csharp
CancelSalesOrderCommand
```

```csharp
{
    Guid OrderId;
}
```
---

### 👥 Заказчики и контакты

---

## 📱 Экран  14. **Заказчики**

**Источник данных:**

* `CUSTOMERS`
* `CONTACTS`
* `CONTACT_LINKS`

---

### 📋 Таблица заказчиков

```text
┌────────────────────────────────────────────────────────────┐
│ Заказчики                                      [+ Добавить] │
├────────────────────────────────────────────────────────────┤
│ Название ↓↑      │ Телефон        │ Email        │ Адрес    │
├──────────────────┼────────────────┼──────────────┼──────────┤
│ ООО Ромашка      │ +7 999 111-22-33│ info@rom.ru  │ Москва   │
│ ИП Иванов        │ +7 900 555-44-33│ —            │ Тверь    │
└────────────────────────────────────────────────────────────┘
```
### 👥 Заказчики — Application слой

---

### 📋 Список заказчиков

### 🔍 Запрос

```csharp
GetCustomersQuery
```

**Возвращает:**

```csharp
CustomerListItemDto
{
    Guid Id;
    string Name;
    string? Phone;
    string? Email;
    string? Address;
}
```

📌 Используется:

* таблица заказчиков
* сортировка
* поиск

---
---

### Взаимодействие

* 👆 короткое нажатие → **карточка заказчика**
* 👆⏱ длительное нажатие →

  * ✏️ **Редактировать** (inline)
  * 🗑 **Удалить** (деактивация)

---

### ➕ Добавить заказчика

```text
Новая строка (inline):
Название: [             ]
Телефон:  [             ]
Email:    [             ]
Адрес:    [             ]

[ Сохранить ] [ Отмена ]
```
### 🔍 Запрос

```csharp
GetCustomerDetailsQuery
```

```csharp
{
    Guid CustomerId;
}
```

---

### ➕ Добавить заказчика

### 🧾 Команда

```csharp
CreateCustomerCommand
```

```csharp
{
    string Name;
    string? Phone;
    string? Email;
    string? Address;
}
```

---

### ✏️ Редактировать заказчика

### 🧾 Команда

```csharp
UpdateCustomerCommand
```

```csharp
{
    Guid CustomerId;
    string Name;
    string? Phone;
    string? Email;
    string? Address;
}
```

📌 Используется для inline-редактирования

---

### 🗑 Удалить заказчика

### 🧾 Команда

```csharp
DeactivateCustomerCommand
```

```csharp
{
    Guid CustomerId;
}
```

📌 Почему deactivate:

* заказчики участвуют в истории заказов
* hard delete — плохая идея
---

## 📱 Экран  15. Карточка заказчика 

```text
← Назад
────────────────────────────
ООО Ромашка

Контакты:
- Телефон: +7 999 111-22-33
- Email: info@rom.ru
- Адрес: Москва

История заказов:
SO-0001 — 12.03.2025 — Завершен
SO-0005 — 18.03.2025 — Новый
```

---

### 🧩 Как это ляжет на файлы (Copilot-friendly)

```text
Application/
 └── SalesOrders/
     ├── Commands/
     │   ├── CreateSalesOrderCommand.cs
     │   ├── UpdateSalesOrderCommand.cs
     │   ├── DeleteSalesOrderCommand.cs
     │   ├── AddSalesOrderItemCommand.cs
     │   ├── UpdateSalesOrderItemCommand.cs
     │   └── RemoveSalesOrderItemCommand.cs
     ├── Queries/
     │   ├── GetSalesOrdersQuery.cs
     │   └── GetSalesOrderDetailsQuery.cs
     └── Dtos/
```

---

# Производство

### FlyoutItems
```text
└── Производство
    ├── Производство (Список производственных заказов, Создание производственного заказа)
    ├── Материалы (Списание материалов)
    └── Этапы (Этапы производства)
```

Добавим еще одну кнопку в карточку заказа [Производство]. И еще во Flyout будет пункт - "Производство".
Пункт "Производство" во Flyout открывают страницу создания производственного заказа. Рядом в Tab будет вкладка 
"Список производственных заказов". При нажатии на кнопку "Производство" в карточке заказа открывается либо список 
производственных заказов, отфильтрованных по этому заказу (т.е. только те производственные заказы, которые 
относятся к этому заказу). Либо открывается страница создания производственного заказа, если у этого заказа еще 
нет производственных заказов.

## 📱 Экран  16. Список производственных заказов

В списке производственных заказов будет список заказов, у которых есть столбцы "Номер" производственного заказа, "Номер заказа" (номер заказа заказчика, на item которого ссылается этот производственный заказ; при коротком 
нажатии на это поле - открыть страницу соответствующего заказа), "Изделие", "Количество", "Статус" (из enum:
"Enum production_order_status_enum {
  NEW
  MATERIAL_ISSUED
  CUTTING
  SEWING
  PACKAGING
  FINISHED
  CANCELLED
}"). Будет загружаться из PRODUCTION_ORDERS. 
При нажатии на строку появляются (или становятся активными) кнопки 
"Этапы производства", "Производственный заказ", "Удалить". Строки пусть будут не редактируемые. 

Есть кнопка [Добавить], которая открывает страницу создания производственного заказа (режим редактирования). 
При нажатии на кнопку "Производственный заказ" открывается страница производственного заказа для этого 
производственного заказа (но уже не в режиме редактирования, а в режиме просмотра).
При нажатии на кнопку "Этапы производства" открывается страница этапов прозводства для этого производственного 
заказа.

```
────────────────────────────────────────────────────────────
Производственные заказы                       [+ Добавить]
────────────────────────────────────────────────────────────
№ ПЗ | № Заказа | Изделие | Кол-во | Отгружено |  Статус
─────┼──────────┼─────────┼────────┼───────────┼──────────
PZ-12| SO-45    | Фартук  | 10     | 10        | FINISHED
PZ-13| SO-46    | Куртка  | 5      | 3         | PACKAGING
PZ-14| SO-46    | Брюки   | 8      | 0         | CUTTING
────────────────────────────────────────────────────────────
```

**Действия**

### При тапе на строку

Появляются кнопки:

* 🏗 **Этапы производства**
* 📄 **Производственный заказ**
* 🗑 **Удалить** (если `NEW`)

---

### Queries

```csharp
GetProductionOrdersQuery
GetProductionOrdersBySalesOrderQuery
GetProductionOrderDetailsQuery
```

### Commands

```csharp
CreateProductionOrderCommand
UpdateProductionOrderCommand
DeleteProductionOrderCommand
```
---

## 📱 Экран  17. Создание производственного заказа

На странице производственного заказа можно создать производственный заказ, если он не создан, либо просмотреть 
его, если он уже создан. Там есть поля (вертикально 
расположенные) - номер (он автоматически добавляется - номер последнего заказа, увеличенный на 1, есть 
поле - заказ (это выпадающий список заказов заказчиков, чтобы привязать его к производственному заказу с 
реактивным фильтром), есть поле - изделие (выпадающий список изделий с реактивным поиском, если заказ уже выбран, 
то из списка товаров этого заказа (надо, чтобы в этот список не входили товары, на которые уже создан производстве
нный заказ, но вручную их можно было бы вписать - или нет, не знаю), а иначе - из всего списка товаров), 
количество (число товаров), цех (выпадающий список цехов - из DEPARTMENTS, отфильтрованных по типу 
"Производственный"). Поля редактируемые, если заказ в производстве не запущен (статус = NEW).

Ниже - список материалов для данного товара (из спецификации товара - PRODUCT_MATERIALS), с указанием необходимого
количества материалов (все значения умноженные на количество товара), суммы доступного материала на всех складах и
количества материала, которого не хватает (либо 0, если хватает). Также в каждой строке с материалом есть кнопка 
"Создать заказ", которая направляет на страницу создания заказа материалов (как в разделе "Материалы" - создание 
заказа материалов). Также в каждой строчке с материалом есть кнопка "Списать материалы", которая открывает 
страницу "Производство / Списание материалов".

Ниже - таблица отгруженного количества товара (из INVENTORY_MOVEMENTS с типом Finished_Goods_Shipment). В этой 
таблице при клике на строку открывается страница соответствующего склада.

Ниже - кнопки "Отменить" и "Этапы производства" (либо "Запустить в производство", если еще не запущен 
в производство).

```
Производственный заказ  PO-15
────────────────────────────────────────────
Заказ клиента:   [SO-45 ▼]  (не редактируемое, если заказ в производстве)
Изделие:         [Фартук ▼] (не редактируемое, если заказ в производстве)
Количество:      [10]       (не редактируемое, если заказ в производстве)
Цех:             [Швейный ▼](не редактируемое, если заказ в производстве)
Статус:          PACKAGING  (не редактируемое, если заказ в производстве)

────────────────────────────────────────────
Материалы (спецификация)
────────────────────────────────────────────
Материал | Нужно | Есть | Не хватает | Действия
─────────┼───────┼──────┼────────────┼────────────
Ситец    | 12 м  | 50 м | 0 ✔       | [Создать заказ] [Списать]
Молния   | 10 шт | 8 шт | 2 ❌       | [Создать заказ] [Списать]

────────────────────────────────────────────
Отгружено
────────────────────────────────────────────
Склад            | Кол-во | Дата
─────────────────┼────────┼──────────
Склад отгрузки   | 6      | 14.09.2025
Склад отгрузки   | 4      | 15.09.2025

────────────────────────────────────────────
[Отменить]  [Этапы производства] (либо [Запустить в производство], если еще не запущен)
```

**Правила**

* `Запустить в производство` активна только если **не хватает = 0**
* Кнопка `Списать` → экран списания

---
**Queries**
```csharp
GetProductionOrderMaterialsQuery
GetProductionOrdersQuery
GetProductionOrderDetailsQuery
GetProductionOrderShipmentsQuery   // агрегирует InventoryMovements
```
**Commands**
```csharp
UpdateProductionOrderCommand (только для NEW)

CreateProductionOrderCommand
DeleteProductionOrderCommand

IssueMaterialsToProductionCommand
StartProductionStageCommand
CompleteProductionStageCommand

ShipFinishedGoodsCommand
CancelProductionOrderCommand
```

➡️ Внутри:

* InventoryMovement (ProductionIssue)
* InventoryMovementItems
* ProductionOrderMaterials
* Status → MATERIAL_ISSUED
---

## 📱 Экран  18. Производство / Списание материалов

На странице "Производство / Списание материалов" написано в заголовке название материала. Ниже указан цех, куда 
списываем. Ниже - строка "Необходимо" и количество, сколько материала нужно для данного производственного заказа 
(все значения умноженные на количество товара), в строке с надписью "Доступно" - сколько материала доступно на 
всех складах и сколько материала не хватает (либо 0, если хватает). Ниже будет таблица. В 1 столбце написан склад,
во втором - количество на этом складе данного материала. В третьем - пользователь вписывает количество для 
списания с данного склада (в этой строке). Если вписал больше, чем есть, то надпись красная сигнализирует об 
ошибке. Склады упорядочены по количеству материала от большего к меньшему. При введении нового значения количества
для списания в строке очередного склада будет уменьшаться значение необходимого материала в строке "Необходимо" 
до 0. А в строке "Доступно" значение тоже будет уменьшаться, чтобы пользователь видел сколько останется материала.
Также при введении значения для списания в строке склада в колонке с количеством доступного материала значение 
тоже будет уменьшаться. 
Если материала не хватает, то есть предупреждение "Недостаточно материала". Есть кнопки [Отмена] и 
[Списать материалы]. 

При нажатии [Списать материалы]:

Создаётся:

* InventoryMovement (ProductionIssue)
 
* InventoryMovementItems
 
* ProductionOrderMaterials

✔️ Cтатус → MATERIAL_ISSUED

При нажатии на кнопку "Списать материалы" пользователь возвращается на страницу производственного заказа, а 
материалы списываются со склада (создается запись в INVENTORY_MOVEMENTS с типом Production_Issue и соответствующие
записи в INVENTORY_MOVEMENT_ITEMS) и создается запись в PRODUCTION_ORDER_MATERIALS, где указывается, какие 
материалы и в каком количестве были списаны.
При этом статус производственного заказа меняется на "MATERIAL_ISSUED", а в списке материалов с 
количестве недостающего материала появляется 0 (если списали со склада необходимое количество). Чтобы стала 
активной кнопка "Запустить в производство" все значения в колонке "Недостаточно" должны быть равны 0.
После запуска в производство открывается страница этого производственного заказа мы переходим на страницу со 
списком производственных заказов, отфильтрованных по этому заказу заказчика. На странице списка заказов в верхней 
строке - последний созданный производственный заказ.

```
Списание материала: Молния
Цех: Швейный
────────────────────────────────────────────
Необходимо: 10 шт
Доступно на складах:   8 шт
Не хватает: 2 шт

────────────────────────────────────────────
Склад           | Есть | Списать | Останется
────────────────┼──────┼─────────┼──────────
Основной        | 5    | [5]     |   [0]
Склад №2        | 3    | [3]     |   [0]

⚠ Недостаточно материала
────────────────────────────────────────────
[Отмена]   [Списать материалы]
```
---
### 🔹 Материалы в производстве (те же, что выше)

```csharp
GetProductionOrderMaterialsQuery
```

```csharp
IssueMaterialsToProductionCommand
```

➡️ Внутри:

* InventoryMovement (ProductionIssue)
* InventoryMovementItems
* ProductionOrderMaterials
* Status → MATERIAL_ISSUED
---

В общем, на страницу "Этапов производства" можно будет перейти только из списка производственных 
заказов, нажав на кнопку "Этапы производства" для конкретного производственного заказа. К списку производственных 
заказов можно прийти после создания нового производственного заказа, со страницы самого заказа, к которому 
привязаны все производственные заказы в списке, через Flyout-вкладку "Производство" в tab-вкладке "Список заказов" 
(производственных).

## 📱 Экран  19. Этапы производства

При нажатии на кнопку "Этапы производства" открывается страница этапов производства для этого цеха.
На странице этапов производства могут быть 3 раскрывающихся блока при нажатии на соответствующие надписи: 
"Раскрой", "Шитье", "Упаковка". В каждом блоке 2 строки: Покроено/Пошито/Упаковано (в зависимости от блока) - 
количество и Осталось - количество. 

Ниже - таблица со списком 
сотрудников (4 столбца - "Сотрудник", "Норма" - норма в час из таблицы товаров, "Назначено" - количество, 
которое назначит начальник, "Выполнено"), которую надо заполнять нажав на кнопку "+" (добавить). Появляется 
новая строчка с выпадающим списком сотрудников с этого цеха, с доступом к соответствующей операции. Пользователь
выбирает нужного, назначает ему необходимое количество, в конце дня записывает, сколько было выполнено 
(количество выполненного записывается в таблицу PRODUCTION_ORDER_DEPARTMENT_EMPLOYEES). Если зажать на строке, 
то появляются (или становятся активными) кнопки "Редактировать" и "Удалить". При редактировании можно менять 
сотрудника (выпадающий список), назначенное количество и выполненное количество. При удалении удаляется запись 
из PRODUCTION_ORDER_DEPARTMENT_EMPLOYEES. 

Внизу таблицы отображается сумма по колонкам "Назначено" и "Выполнено".

```
Производственный заказ: PO-12
Изделие: Фартук | Кол-во: 10
────────────────────────────────────────────

▼ Раскрой
Покроено: 6   Осталось: 4
────────────────────────────────────────────
Сотрудник | Назначено | Выполнено
──────────┼───────────┼───────────
Иванов    | 4         | 3
Петин    | 2         | 2
────────────────────────────────────────────
Итого:          6         5
[+ Добавить]

▼ Шитьё
Пошито: 3   Осталось: 7
────────────────────────────────────────────
Сотрудник | Норма | Назначено | Выполнено
──────────┼───────┼───────────┼───────────
Иванов    | 2.5   | 6         | 1
Петров   | 2.5   | 4         | 2
────────────────────────────────────────────
Итого:          6         5
[+ Добавить]

▼ Упаковка
Упаковано: 1   Осталось: 9
────────────────────────────────────────────
Сотрудник | Назначено | Выполнено
──────────┼───────────┼───────────
Сидоров  | 5         | 1
Ванюхин  | 5         | 0
────────────────────────────────────────────
Итого:          6         5
[+ Добавить]
```
---

### 🔹 Этапы производства

### Queries

```csharp
GetProductionStagesQuery
GetProductionStageEmployeesQuery
```

### Commands

```csharp
StartProductionStageCommand        // CUTTING / SEWING / PACKAGING
AddProductionStageEmployeeCommand
UpdateProductionStageEmployeeCommand
RemoveProductionStageEmployeeCommand
CompleteProductionStageCommand
```
---


# Организация

### FlyoutItems
```text
└──Организация
    ├── Организация (Сотрудники — список, Карточка сотрудника)
    ├── Участки (Участки)
    └── Должности (Должности, Карточка должности)
```

## 📱 Экран  20. Список сотрудников

**Источник данных:**

* `EMPLOYEES`
* `DEPARTMENTS`

```text
┌────────────────────────────────────────────────────────────┐
│ Сотрудники        [Поиск...]                  [+ Добавить] │
├────────────────────────────────────────────────────────────┤
│ ФИО ↓↑           │ Цех        │ Должность │ Активен │
├──────────────────┼────────────┼───────────┼─────────┤
│ Иванов И.И.      │ Швейный    │ Швея      │ ✔       │
│ Петров П.П.      │ Раскрой    │ Закройщик │ ✔       │
│ Сидорова А.А.    │ Упаковка   │ Упаковщик │ ✖       │
└──────────────────┴────────────┴───────────┴─────────┘
```

### UX

* 🔼🔽 сортировка:

  * по ФИО
  * по цеху
* 🔍 поиск по ФИО
* 👆 короткое нажатие → **карточка сотрудника**
* 👆⏱ длительное нажатие →

  * ✏️ Редактировать
  * 🗑 Деактивировать

---

### ➕ Добавление сотрудника (открывается карточка в режиме редактирования по кнопке [+ Добавить])

```text
Добавление сотрудника
────────────────────────────
ФИО:            [ Иванов Иван ]
Цех:            [ ▼ Швейный ]
Должность:      [ Швея ]
Дата приёма:    01.09.2025
Активен:        ✔

[ Создать ]
[ Отмена ]
```
### 📋 Список сотрудников

### 🔍 Query

```csharp
GetEmployeesQuery
```

**Возвращает:**

```csharp
EmployeeListItemDto
{
    Guid Id;
    string FullName;
    string DepartmentName;
    string Position;
    bool IsActive;
}
```
---

## 📱 Экран  21. Карточка сотрудника

```text
← Назад                    Иванов Иван Иванович
────────────────────────────────────────────────
Цех:            Швейный
Должность:      Швея
Дата приёма:    01.09.2025
Статус:         Активен
Разряд:          3
Процент за переработку: 15%
Ставка за час: 200 руб.

[ Редактировать ]   [ Деактивировать ]

[ Начисления ]
[ Выплаты ]
```
"Начисления" и "Выплаты" — переход на соответствующие страницы 
---

### 🏭 Участие в производстве (read-only)

```text
Текущие задания
────────────────────────────────
Производственный заказ │ Этап   │ Назначено │ Выполнено
───────────────────────┼────────┼───────────┼───────────
PZ-12                  │ Пошив  │ 3         │ 2
PZ-15                  │ Пошив  │ 2         │ 0
```

👆 клик → соответствующий производственный заказ

---

### 📄 Детализация табеля (по сотруднику)

```text
[DatePicker] Март 2025    [+]
────────────────────────────
Дата       │ Часы │ Примечание
────────────────────────────
01.03      │ 8    │
02.03      │ 8    │
03.03      │ 6    │ Отгул
...
```

---
Через DatePicker выбирается месяц и год. Через кнопку [+] добавляется новая строка
(с текущей датой, по умолчанию, если выбран соответствующий месяц и год).
Можно редактировать в таблице табеля (обновляется и сохраняется при выходе из карточки 
сотрудника)

### Application слой — запросы и команды

### 📄 Карточка сотрудника

```csharp
GetEmployeeDetailsQuery
```

```csharp
{
    Guid EmployeeId;
}
```

```csharp
EmployeeDetailsDto
{
    Guid Id;
    string FullName;

    PositionDto Position;
    int Grade;

    decimal RatePerNormHour;
    decimal PremiumPercent;

    DateOnly HiredAt;
    DateOnly? FiredAt;
    bool IsActive;

    IReadOnlyList<ContactDto> Contacts;
}
```

---

### ➕ Создание

```csharp
CreateEmployeeCommand
```

```csharp
{
    string FullName;
    Guid PositionId;
    int Grade;
    decimal RatePerNormHour;
    decimal PremiumPercent;
    DateOnly HiredAt;
}
```

📌 Правила:

* IsActive = true

* FiredAt = null

---

### ✏️ Редактирование

```csharp
UpdateEmployeeCommand
```

```csharp
{
    Guid EmployeeId;

    string FullName;
    Guid PositionId;
    int Grade;

    decimal RatePerNormHour;
    decimal PremiumPercent;
}
```

---

### 🔄 Активация / деактивация

```csharp
DeactivateEmployeeCommand
ActivateEmployeeCommand
```

```csharp
{
    Guid EmployeeId;
}
```
---

### 🧾 Application слой — Табель

### Запросы

```csharp
GetTimesheetsQuery
{
    Guid? EmployeeId;
    Guid? DepartmentId;
    YearMonth Period;
}
```

```csharp
TimesheetListItemDto
{
    Guid EmployeeId;
    string EmployeeName;
    string DepartmentName;
    decimal TotalHours;
    int WorkDays;
}
```

---

```csharp
GetEmployeeTimesheetDetailsQuery
{
    Guid EmployeeId;
    YearMonth Period;
}
```

---

### Команды

```csharp
AddTimesheetEntryCommand
{
    Guid EmployeeId;
    DateTime Date;
    decimal Hours;
    string? Comment;
}
```

```csharp
UpdateTimesheetEntryCommand
{
    Guid EntryId;
    decimal Hours;
    string? Comment;
}
```

```csharp
RemoveTimesheetEntryCommand
{
    Guid EntryId;
}
```

---

### Связь с производством

В **этапах производства** ты уже используешь:

```text
PRODUCTION_ORDER_DEPARTMENT_EMPLOYEES
```

Сотрудник:

* назначается
* имеет норму
* имеет факт выполнения

👉 **Карточка сотрудника — это точка входа “от человека”**
👉 **Производственный заказ — точка входа “от заказа”**

Обе стороны **сходятся на одной таблице**

---


## 📱 Экран  22. Участки

Источник данных: `DEPARTMENTS`

```text
┌────────────────────────────────────────────┐
│ Участки / Цеха                [+ Добавить] │
├────────────────────────────────────────────┤
│ Код │ Наименование        │ Тип            │
├─────┼─────────────────────┼────────────────┤
│ SHW │ Швейный цех         │ Производст.    │
│ CUT │ Участок раскроя     │ Производст.    │
│ ADM │ Администрация       │ Админ          │
└────────────────────────────────────────────┘
```

### Поведение

* 👆 короткое нажатие → **карточка участка**
* 👆⏱ долгое → **Редактировать / Деактивировать**
* сортировка по названию

---

## 📱 Экран  23. Карточка участка (всегда редактируемая)

```text
← Назад
────────────────────────────
Наименование:   [ Швейный цех ]
Код:            [ SHW ]
Тип:            [ Производственный ▼ ]

Активен:        [ ✔ ]

[ Сохранить ]
[ Отмена ]
```

---

### 🧾 Application — Участки

### Запросы

```csharp
GetDepartmentsQuery
```

```csharp
DepartmentListItemDto
{
    Guid Id;
    string Code;
    string Name;
    DepartmentType Type;
    bool IsActive;
}
```

---

### Команды

```csharp
CreateDepartmentCommand
{
    string Name;
    string Code;
    DepartmentType Type;
}
```

```csharp
UpdateDepartmentCommand
{
    Guid DepartmentId;
    string Name;
    string Code;
    DepartmentType Type;
    bool IsActive;
}
```

---

### 🧩 Должности

Источник данных: `POSITIONS`, `DEPARTMENTS`

---

## 📱 Экран  24. Должности

```text
┌────────────────────────────────────────────┐
│ Должности                     [+ Добавить] │
├────────────────────────────────────────────┤
│ Код │ Наименование          │ Цех          │
├─────┼───────────────────────┼──────────────┤
│ SHW │ Швея                  │ Швейный цех  │
│ CUT │ Раскройщик            │ Раскрой      │
│ PKG │ Упаковщик             │ Упаковка     │
└────────────────────────────────────────────┘
```

### Поведение

* 👆 короткое → **карточка должности**
* 👆⏱ долгое → **Редактировать / Деактивировать**
* сортировка по коду / названию

---

## 📱 Экран  25. Карточка должности (всегда в режиме редактирования)

```text
← Назад
────────────────────────────────────────────
Наименование:        [ Швея ]
Код должности:       [ SHW ]
Цех:                [ Швейный цех ▼ ]

Базовая ставка:     [ 350 ]
Премия по умолч.:   [ 20 % ]

Разрешенные операции:
[✔] Раскрой
[✔] Пошив
[ ] Упаковка
[ ] Склад

Актуальна:          [ ✔ ]

[ Сохранить ]
[ Отмена ]
```

📌 **Принцип**
Карточка открывается **только для создания или редактирования**, режима “просмотра” нет.

---

### 🧾 Application — Должности

### Запросы

```csharp
GetPositionsQuery
```

```csharp
PositionListItemDto
{
    Guid Id;
    string Code;
    string Name;
    string DepartmentName;
    bool IsActive;
}
```

---

```csharp
GetPositionDetailsQuery
{
    Guid PositionId;
}
```

```csharp
PositionDetailsDto
{
    Guid Id;
    string Name;
    string? Code;
    Guid DepartmentId;

    decimal? BaseNormPerHour;
    decimal? BaseRatePerNormHour;
    decimal? DefaultPremiumPercent;

    bool CanCut;
    bool CanSew;
    bool CanPackage;
    bool CanHandleMaterials;

    bool IsActive;
}
```

---

### Команды

```csharp
CreatePositionCommand
{
    string Name;
    string? Code;
    Guid DepartmentId;

    decimal? BaseNormPerHour;
    decimal? BaseRatePerNormHour;
    decimal? DefaultPremiumPercent;

    bool CanCut;
    bool CanSew;
    bool CanPackage;
    bool CanHandleMaterials;
}
```

---

```csharp
UpdatePositionCommand
{
    Guid PositionId;

    string Name;
    string? Code;
    Guid DepartmentId;

    decimal? BaseNormPerHour;
    decimal? BaseRatePerNormHour;
    decimal? DefaultPremiumPercent;

    bool CanCut;
    bool CanSew;
    bool CanPackage;
    bool CanHandleMaterials;

    bool IsActive;
}
```

---

### 🔗 Связь с сотрудниками

📌 В `EMPLOYEES`:

* `position_id` — **обязателен**
* при деактивации должности:

  * нельзя назначить новым сотрудникам
  * существующие — остаются (история)

---


# Финансы

### FlyoutItems
```text
└──Финансы
    ├── Зарплата (Начисления зарплаты, Детализация по дням, Правила расчёта зарплаты, Карточка правила)
    ├── Расходы (Категории расходов, Расходы, Подотчетные авансы, Карточка аванса, Создание аванса)
    └── Отчеты (Список финансовых отчётов, Карточка месячного отчёта)
```

## 📱 Экран  26. Начисления зарплаты

Flyout → **Финансы → Начисления зарплаты**

Фильтры сверху:

```text
Период:   [ 01.03.2025 ] — [ 31.03.2025 ] - 2 DatePickers
Сотрудник:[ Все ▼ ]
Цех:      [ Все ▼ ]
% премии: [ X% за перевыполнение ▼ ]   ← PAYROLL_RULES
```
Долгое нажатие или двойной тап по строке % премии → экран редактирования правил премий
---

### 📋 Таблица начислений (агрегированный вид)

```text
┌────────────────────────────────────────────────────────────────────────────┐
│ Сотрудник │  Часы │ План │ Факт │ Сверх │ Начислено │ Выплачено │ Осталось │
├───────────┼───────┼──────┼──────┼───────┼───────────┼───────────┼──────────┤
│ Иванов И. │  40.0 │ 20   │ 22   │ 2     │ 3 200 ₽   │ 1 500 ₽   │ 1 700 ₽  │
│ Петров И. │  40.0 │ 20   │ 20   │ 0     │ 3 000 ₽   │ 0 ₽       │ 3 000 ₽  │
└────────────────────────────────────────────────────────────────────────────┘

```

🔹 Это **агрегация PAYROLL_ACCRUALS по месяцу**.

**Поведение столбцов**

- Начислено — total_amount

- Выплачено — сумма из PAYROLL_PAYMENTS

- Осталось = total_amount - paid_amount

📌 paid_amount можно:

- либо хранить денормализованно

- либо считать на лету (лучше сначала считать)

---

### 👆 Короткий тап → детализация по дням (ключевой экран)



## 📱 Экран  27. Детализация по дням

```text
← Назад  

Иванов И.И. 
Должность: Швея 3 разряда
Период:   [ 01.03.2025 ] — [ 31.03.2025 ] - 2 DatePickers

Сумма для выплаты: [3000 ₽]  [Выплатить] <- меняются значения Начислено, Выплачено, Осталось в Таблице начислений

────────────────────────────────────────────────────────────────────
Дата     │ Часы │ План │ Факт │ Сверх │ База ₽ │ Премия ₽ │ Итого ₽
────────────────────────────────────────────────────────────────────
01.03    │ 8    │ 20   │ 22   │ 2     │ 2 800  │ 420      │ 3 220
02.03    │ 8    │ 20   │ 20   │ 0     │ 2 800  │ 0        │ 2 800
03.03    │ 6    │ 15   │ 18   │ 3     │ 2 100  │ 630      │ 2 730

Всего:   │ 22   │ 55   │ 60   │ 5     │ 7 700  │ 1 050    │ 11 750
```

➡️ **1 строка = 1 запись PAYROLL_ACCRUALS**

Это **ровно твоя таблица**, без костылей.

---

### Связь с табелем и производством (очень важно)

### 🔗 Источники данных для расчёта PAYROLL_ACCRUALS

| Поле в PAYROLL_ACCRUALS | Откуда берётся                             |
| ----------------------- | ------------------------------------------ |
| `hours_worked`          | `TIMESHEETS`                               |
| `qty_planned`           | `PRODUCT.plan_per_hour × hours_worked`     |
| `qty_produced`          | из `PRODUCTION_ORDER_DEPARTMENT_EMPLOYEES` |
| `qty_extra`             | `max(0, produced - planned)`               |
| `base_amount`           | `hours_worked × rate_per_norm_hour`        |
| `premium_amount`        | `qty_extra × rate × premium_percent`       |
| `total_amount`          | `base + premium`                           |

📌 **PAYROLL_ACCRUALS — вычисляемая, но сохраняемая сущность**
(это правильно, иначе перерасчёты будут адом)

---

### Application слой — что обязательно нужно

### 🔍 Запросы

### Список начислений (по месяцу)

```csharp
GetPayrollAccrualsQuery
{
    DateOnly From;
    DateOnly To;
    Guid? EmployeeId;
    Guid? DepartmentId;
}
```

```csharp
PayrollAccrualListItemDto
{
    Guid EmployeeId;
    string EmployeeName;

    decimal TotalHours;
    decimal QtyPlanned;
    decimal QtyProduced;
    decimal QtyExtra;

    decimal BaseAmount;
    decimal PremiumAmount;
    decimal TotalAmount;
}
```

---

### Детализация по сотруднику

```csharp
GetEmployeePayrollAccrualsQuery
{
    Guid EmployeeId;
    YearMonth Period;
}
```

---

### 🧮 Команды (ключевой момент)

### Автоматический расчёт за день

```csharp
CalculateDailyPayrollAccrualCommand
{
    Guid EmployeeId;
    DateTime Date;
}
```

📌 Используется:

* после закрытия смены
* или вручную бухгалтером

---

### Массовый расчёт за период

```csharp
CalculatePayrollAccrualsForPeriodCommand
{
    YearMonth Period;
}
```
### 💰 Выплаты

### Выплатить зарплату (аванс / окончательный)

```csharp
CreatePayrollPaymentCommand
{
    Guid EmployeeId;
    DateOnly PaymentDate;
    decimal Amount;
}
```

📌 После выполнения:

* обновляется `paid_amount`
* пересчитывается `remaining_amount`
---

### Корректировка (бухгалтерская!)

```csharp
AdjustPayrollAccrualCommand
{
    Guid AccrualId;
    decimal BaseAmount;
    decimal PremiumAmount;
    string Reason;
}
```

✔️ **Обязательно** — жизнь без этого невозможна.

---

## 📱 Экран  28. Правила расчёта зарплаты

### 📱 Flyout → Финансы → Правила зарплаты

```text
┌─────────────────────────────────────────────┐
│ Правила расчёта зарплаты       [+ Добавить] │
├─────────────────────────────────────────────┤
│ Дата с     │ % премии │ Описание            │
├────────────┼──────────┼─────────────────────┤
│ 01.01.2025 │ 20 %     │ Базовое правило     │
│ 15.03.2025 │ 30 %     │ Повышение нормы     │
└─────────────────────────────────────────────┘
```

👆 Короткий тап → редактирование
⏱ Долгий тап → удалить (если не используется)

---

## 📱 Экран  29. Карточка правила (всегда редактируемая)

```text
Дата начала:      [ 15.03.2025 ]
Премия (%):       [ 30 ]
Описание:         [ Повышение нормы ]

[ Сохранить ]
[ Отмена ]
```
### Ключевой принцип (важно ❗)

> **Правила не редактируют уже начисленную зарплату.**
> Они **выбираются по дате начисления** и **копируются в PAYROLL_ACCRUALS**.

📌 То есть:

* PAYROLL_RULES — *источник*
* PAYROLL_ACCRUALS — *зафиксированный результат*

---

### Как применяется правило

При расчёте начислений за день **D**:

```text
Берём PAYROLL_RULE
WHERE effective_from <= D
ORDER BY effective_from DESC
LIMIT 1
```

И используем `premium_percent` **только для этого дня**.

❗ Ограничения:

* нельзя удалять правило, если есть начисления с этой датой
* можно только добавить новое

---

### Application слой — команды и запросы

### 📌 Правила зарплаты

### Получить список правил

```csharp
GetPayrollRulesQuery
```

```csharp
PayrollRuleDto
{
    Guid Id;
    DateOnly EffectiveFrom;
    decimal PremiumPercent;
    string Description;
}
```

---

### Создать правило

```csharp
CreatePayrollRuleCommand
{
    DateOnly EffectiveFrom;
    decimal PremiumPercent;
    string Description;
}
```

📌 Проверки:

* `EffectiveFrom` уникальна
* `PremiumPercent >= 0`

---

## 📱 Экран  30. Категории расходов

### Источник данных

* `EXPENSE_TYPES`

---

### UI

```text
Типы расходов                         [+ Добавить]
──────────────────────────────────────────────────
Код │ Наименование         │ Описание
────┼─────────────────────┼──────────────────────
01  │ Аренда               │ Аренда помещения
02  │ Коммунальные услуги  │ Свет, вода, отопление
03  │ Прочие               │ Разные расходы
```

### Взаимодействие

* 👆 короткий тап → редактирование
* 👆⏱ долгий тап → удалить

---

### Application

### 📋 Список типов

```csharp
GetExpenseTypesQuery
```

```csharp
ExpenseTypeDto
{
    Guid Id;
    string Name;
    string Description;
}
```

---

### ➕ Создание / редактирование

```csharp
CreateExpenseTypeCommand
{
    string Name;
    string Description;
}
```

```csharp
UpdateExpenseTypeCommand
{
    Guid Id;
    string Name;
    string Description;
}
```

---

### 🗑 Удаление

```csharp
DeleteExpenseTypeCommand
{
    Guid Id;
}
```

📌 Правило:

* нельзя удалить, если есть `EXPENSES`

---

## 📱 Экран  31. Расходы 

### Источник данных

* `EXPENSES`
* `EXPENSE_TYPES`
* `USERS`

---

### Фильтр сверху

```text
Период: [ Март 2025 ▼ ]   Тип: [ Все ▼ ]   [+ Добавить]
```

---

### Таблица расходов

```text
┌──────────────────────────────────────────────────────────────┐
│ Дата       │ Тип        │ Описание        │ Сумма    │ Автор │
├────────────┼────────────┼─────────────────┼──────────┼───────┤
│ 05.03.2025 │ Аренда     │ За март         │ 120 000  │ Анна  │
│ 10.03.2025 │ Коммуналка │ Электроэнергия  │ 18 500   │ Иван  │
│ 15.03.2025 │ Прочие     │ Хоз. товары     │ 4 200    │ Анна  │
└──────────────────────────────────────────────────────────────┘
```

### Итоговая строка (фиксированная)

```text
Итого за период: 142 700 ₽
```

---

### Взаимодействие

* 👆 короткий тап → просмотр / редактирование
* 👆⏱ долгий тап →

  * ✏️ Редактировать
  * 🗑 Удалить

---

➕ Добавить расход можно в строке таблицы

---

### Application

### 📋 Список расходов

```csharp
GetExpensesQuery
{
    DateOnly From;
    DateOnly To;
    Guid? ExpenseTypeId;
}
```

```csharp
ExpenseListItemDto
{
    Guid Id;
    DateOnly ExpenseDate;
    string ExpenseTypeName;
    decimal Amount;
    string Description;
    string CreatedBy;
}
```

---

### ➕ Создание

```csharp
CreateExpenseCommand
{
    Guid ExpenseTypeId;
    DateOnly ExpenseDate;
    decimal Amount;
    string Description;
}
```

📌 `created_by`, `created_at` — внутри

---

### ✏️ Редактирование

```csharp
UpdateExpenseCommand
{
    Guid Id;
    DateOnly ExpenseDate;
    Guid ExpenseTypeId;
    decimal Amount;
    string Description;
}
```

---

### 🗑 Удаление

```csharp
DeleteExpenseCommand
{
    Guid Id;
}
```

📌 Правило:

* удалять может только создатель или администратор

---

Отлично, спасибо — с этими таблицами картина стала **очень чистой и бухгалтерски корректной**. Ниже я **строго опираюсь на твой ERD**, ничего не придумываю сверх него, только правильно интерпретирую.

Я разделю ответ на 4 части:

1. Логическая модель подотчёта (как считать суммы)
2. UI: список авансов
3. UI: карточка аванса
4. Application слой: запросы и команды

В конце — короткие замечания по UX и корректности.



## 📱 Экран  32. Подотчётные авансы

**Flyout → Финансы → Подотчёт**

### Источники данных

* `CASH_ADVANCES`
* `EMPLOYEES`
* агрегаты по `CASH_ADVANCE_EXPENSES`, `CASH_ADVANCE_RETURNS`

---

### 📋 Таблица

```text
Подотчётные авансы                            [+ Выдать]
────────────────────────────────────────────────────────
Дата       │ Сотрудник     │ Выдано │ Потрачено │ Возвращено │ Долг │ Статус
───────────┼───────────────┼────────┼───────────┼────────────┼──────┼────────
05.03.2025 │ Иванов И.И.   │ 20 000 │ 18 500    │ 1 000      │ 500  │ Открыт
10.03.2025 │ Петров П.П.   │ 15 000 │ 15 000    │ 0          │ 0    │ Закрыт
12.03.2025 │ Сидоров С.С.  │ 10 000 │ 12 000    │ 0          │ -2k  │ Открыт
```

### UX

* 🔴 долг < 0 — красным
* 👆 короткий / двойной тап → **карточка аванса**
* 👆⏱ долгий тап →

  * ✏️ (если открыт)
  * 🗑 (если нет операций)

---

### Application

### 📋 Получить список

```csharp
GetCashAdvancesQuery
{
    DateOnly? From;
    DateOnly? To;
    Guid? EmployeeId;
}
```

```csharp
CashAdvanceListItemDto
{
    Guid Id;
    DateOnly IssueDate;
    string EmployeeName;

    decimal IssuedAmount;
    decimal SpentAmount;
    decimal ReturnedAmount;
    decimal Balance;

    bool IsClosed;
}
```

---

## 📱 Экран  33. Карточка аванса

### Источники

* `CASH_ADVANCES`
* `CASH_ADVANCE_EXPENSES`
* `CASH_ADVANCE_RETURNS`

---

### 🧾 Шапка

```text
← Назад          Аванс № CA-00012
──────────────────────────────────
Сотрудник:   Иванов И.И.
Дата выдачи: 05.03.2025

Выдано:      20 000 ₽
Потрачено:   18 500 ₽
Возвращено:  1 000 ₽
────────────────────
Долг:        500 ₽        (🔴 если < 0)
Статус:      Открыт
```

> Все поля — **read-only**, пересчитываются автоматически.

---

### ➕ Добавить сумму (выдача / доплата сотруднику)

```text
Добавить сумму:
[ 2 000 ]    [ Добавить ]
```

### Application

```csharp
AddCashAdvanceAmountCommand
{
    Guid CashAdvanceId;
    DateOnly IssueDate;
    decimal Amount;
}
```

📌 Фактически:

* создаётся **новая запись CASH_ADVANCES**? ❌
* ❗ НЕТ — **это доплата**, логичнее:

  * либо отдельная команда (как у тебя)
  * либо трактуется как отрицательный возврат
    Ты предложил отдельное поле — **это ок**, но:
    ➡️ **рекомендую оформлять доплату как отрицательный возврат** (см. ниже UX-замечание)

---

### ↩️ Возврат денег сотрудником

```text
Вернул сумму:
[ 1 000 ]    [ Вернул ]
```

### Application

```csharp
CreateCashAdvanceReturnCommand
{
    Guid CashAdvanceId;
    DateOnly ReturnDate;
    decimal Amount;
    string Description;
}
```

---

### 📋 Таблица операций (единый список)

```text
Операции по авансу                      [+ Добавить расход]
──────────────────────────────────────────────────────────
Дата       │ Тип        │ Описание          │ Сумма
───────────┼────────────┼───────────────────┼────────
06.03.2025 │ Расход     │ Материалы         │ 5 000
08.03.2025 │ Расход     │ Транспорт         │ 13 500
10.03.2025 │ Возврат    │ Остаток           │ -1 000
```

### Правила отображения

* расход → `+`
* возврат → `-`
* если предприятие вернуло сотруднику → `-` и 🔴

---

### ➕ Добавить расход

При нажатии **[+ Добавить расход]** появляется редактируемая строка.

### Application

```csharp
CreateCashAdvanceExpenseCommand
{
    Guid CashAdvanceId;
    DateOnly ExpenseDate;
    decimal Amount;
    string Description;
}
```

📌 Ограничений по сумме **нет** (долг может стать отрицательным).

---

### 🔒 Автоматическое закрытие

После **каждой операции**:

```text
если Balance == 0 → CloseCashAdvanceCommand
```

```csharp
CloseCashAdvanceCommand
{
    Guid CashAdvanceId;
}
```
---

# Логика подотчёта (как считать автоматически)

Для `CASH_ADVANCES` считаем агрегаты:

```text
Выдано        = CASH_ADVANCES.amount

Потрачено     = SUM(CASH_ADVANCE_EXPENSES.amount)

Возвращено    = SUM(CASH_ADVANCE_RETURNS.amount)

Долг          = Выдано - Потрачено - Возвращено
```

Статус:

* `Открыт` → `Долг != 0`
* `Закрыт` → `Долг == 0` → вызываем `CloseCashAdvanceCommand`

⚠️ ВАЖНО
Долг может быть **отрицательным** → предприятие должно сотруднику.
---

## 📱 Экран  34. Создание аванса

### UI

```text
Выдать аванс
────────────────────────────
Сотрудник:   [ Иванов И.И. ▼ ]
Дата:        [ 18.03.2025 ]
Сумма:       [ 20 000 ]
Описание:    [ Хоз. нужды ]

[ Выдать ]
[ Отмена ]
```

---

### Application

```csharp
CreateCashAdvanceCommand
{
    Guid EmployeeId;
    DateOnly IssueDate;
    decimal Amount;
    string Description;
}
```

## 📱 Экран  35. Список финансовых отчётов

### Flyout → **Финансы → Месячные отчёты**

### Источники

* `MONTHLY_FINANCIAL_REPORTS`

---

### 📋 Таблица

```text
Финансовые отчёты по месяцам               [+ Рассчитать месяц]
──────────────────────────────────────────────────────────────
Год │ Месяц │ Доход │ Зарплата │ Материалы │ Прочее │ Прибыль │ Статус
────┼───────┼───────┼──────────┼───────────┼─────────┼─────────┼────────
2025│ Март  │ 1 200k│ 450k     │ 320k      │ 110k    │ 320k    │ CALCULATED
2025│ Февр. │ 980k  │ 410k     │ 290k      │ 95k     │ 185k    │ CLOSED
```

### UX

* 👆 короткий тап → **карточка отчёта**
* 🔒 `CLOSED` — всё read-only
* [+ Рассчитать месяц] — только если отчёта нет

---

### Формулы (ключевое)

```text
total_revenue
= SUM(отгруженные товары * цена продажи)

payroll_expenses
= SUM(PAYROLL_ACCRUALS.total_amount за месяц)

material_expenses
= SUM(стоимость списанных материалов за месяц)
  (через INVENTORY_MOVEMENTS + PURCHASES)

other_expenses
= SUM(EXPENSES + CASH_ADVANCE_EXPENSES за месяц)

profit
= total_revenue
  - payroll_expenses
  - material_expenses
  - other_expenses
```

👉 `profit` можно:

* либо считать на лету
* либо хранить в отчёте (опционально, но я бы добавил)

---

### Application

### 📋 Получить список

```csharp
GetMonthlyFinancialReportsQuery
```

```csharp
MonthlyFinancialReportListItemDto
{
    int Year;
    int Month;

    decimal TotalRevenue;
    decimal PayrollExpenses;
    decimal MaterialExpenses;
    decimal OtherExpenses;
    decimal Profit;

    MonthlyReportStatus Status;
}
```

---

## 📱 Экран  36. Карточка месячного отчёта

### Источники

* `MONTHLY_FINANCIAL_REPORTS`
* агрегаты из:

  * SALES / SHIPMENTS
  * PAYROLL
  * INVENTORY
  * EXPENSES / CASH_ADVANCES

---

### 🧾 Заголовок

```text
← Назад            Финансовый отчёт — Март 2025
──────────────────────────────────────────────
Статус: CALCULATED
Рассчитан: 31.03.2025 23:59
Создал:    Иван Петров
```

---

### 💰 Блок: Доходы

```text
Доходы
────────────────────────
Отгружено продукции:   1 200 000 ₽
```

[Подробнее] → список отгрузок (read-only)

---

### 👷 Зарплата

```text
Зарплата
────────────────────────
Начислено:             450 000 ₽
```

[Подробнее] → агрегат PAYROLL_ACCRUALS

---

### 🧵 Материалы

```text
Материалы
────────────────────────
Списано материалов:    320 000 ₽
```

[Подробнее] → INVENTORY_MOVEMENTS (Production Issue)

---

### 📦 Прочие расходы

```text
Прочие расходы
────────────────────────
Эксплуатация:          110 000 ₽
```

[Подробнее] → EXPENSES + CASH_ADVANCE_EXPENSES

---

### 📊 Итог

```text
────────────────────────
ИТОГО:
Доходы:               1 200 000 ₽
Расходы:                880 000 ₽
────────────────────────
ПРИБЫЛЬ:                320 000 ₽
```

---

### 🔘 Кнопки (в зависимости от статуса)

### DRAFT / CALCULATED

```text
[ Пересчитать ]   [ Утвердить ]
```

### APPROVED

```text
[ Закрыть месяц ]
```

### CLOSED

```text
(всё заблокировано)
```

---

### Application слой — команды

### ➕ Рассчитать месяц

```csharp
CalculateMonthlyFinancialReportCommand
{
    int Year;
    int Month;
}
```

📌 Логика:

* если отчёта нет → создать
* если `DRAFT` → пересчитать
* если `CLOSED` → ❌ ошибка

---

### 🔄 Пересчитать

```csharp
RecalculateMonthlyFinancialReportCommand
{
    int Year;
    int Month;
}
```

📌 Только если:

* `Status != CLOSED`

---

### ✅ Утвердить

```csharp
ApproveMonthlyFinancialReportCommand
{
    int Year;
    int Month;
}
```

📌 Перевод:
`CALCULATED → APPROVED`

---

### 🔒 Закрыть месяц

```csharp
CloseMonthlyFinancialReportCommand
{
    int Year;
    int Month;
}
```

📌 После этого:

* нельзя менять:

  * зарплаты
  * расходы
  * отгрузки задним числом
* любые попытки → доменная ошибка

---

### Важные архитектурные замечания

### Это **snapshot**, не live-view

Очень правильно, что ты сделал отдельную таблицу.
Иначе бухгалтерия «поехала» бы при каждом изменении задним числом.

---

### Финансы зависят от складских движений

Доход считается **по факту отгрузки**, а не по заказу.

Это:

* правильно
* совпадает с ТЗ
* масштабируется

---

### MONTHLY_FINANCIAL_REPORTS — агрегат

Он:

* **не редактируется вручную**
* только пересчитывается
* фиксируется статусами

---

### FlyoutItems
```text
└── Пользователи (Пользователи, Карточка пользователя, Роли)
```

## 📱 Экран  37. Пользователи 

**Источник данных:** `USERS`, `ROLES`

```text
┌──────────────────────────────────────────────────────────┐
│ Пользователи                                [+ Добавить] │
├──────────────────────────────────────────────────────────┤
│ Логин      │ Роль        │ Статус     │ Создан           │
├────────────┼─────────────┼────────────┼──────────────────┤
│ admin      │ ADMIN       │ Активен    │ 01.01.2025       │
│ ivanov     │ ACCOUNTANT  │ Активен    │ 10.02.2025       │
│ petrov     │ WAREHOUSE   │ Заблокирован │ 15.02.2025     │
└──────────────────────────────────────────────────────────┘
```

### 🔍 Взаимодействие

* 👆 короткий тап → карточка пользователя
* 👆⏱ долгий тап →

  * ✏️ Редактировать
  * 🔒 Заблокировать / Разблокировать

---

### 🔍 Запрос

```csharp
GetUsersQuery
```

```csharp
UserListItemDto
{
    Guid Id;
    string Username;
    string RoleName;
    bool IsActive;
    DateTime CreatedAt;
}
```

---

### ➕ Создание пользователя

```text
Создание пользователя
────────────────────────
Логин:        [ admin2 ]
Пароль:       [ ******** ]
Повтор пароля:[ ******** ]
Роль:         [ ▼ ADMIN ]
Статус:       Активен ☑

[ Создать ]
[ Отмена ]
```

### 🧾 Команда

```csharp
CreateUserCommand
{
    string Username;
    string Password;
    Guid RoleId;
}
```

📌 Логика:

* пароль хэшируется внутри
* `is_active = true`
* `created_at = now`

---

## 📱 Экран  38. Карточка пользователя

```text
Пользователь: ivanov
────────────────────────
Роль:        ACCOUNTANT ▼
Статус:      Активен ☑
Создан:      10.02.2025
```

### Кнопки

```text
[ Сохранить ]
[ Заблокировать ]
```

---

### ✏️ Команды

### Изменение роли / статуса

```csharp
UpdateUserCommand
{
    Guid UserId;
    Guid RoleId;
    bool IsActive;
}
```

---

### 🔒 Блокировка пользователя

```csharp
DeactivateUserCommand
{
    Guid UserId;
}
```

📌 Фактически:

```text
is_active = false
```

---

## 📱 Экран  39. Роли

**Источник:** `ROLES`

```text
┌───────────────────────────────┐
│ Роли             [+ Добавить] │
├───────────────────────────────┤
│ Название роли                 │
├───────────────────────────────┤
│ ADMIN                         │
│ MANAGER                       │
│ ACCOUNTANT                    │
│ WAREHOUSE                     │
│ PRODUCTION                    │
└───────────────────────────────┘
```

📌 В MVP:

* роли **не удаляются**
* можно добавлять новые при необходимости

---

### 🔍 Запрос

```csharp
GetRolesQuery
```

```csharp
RoleDto
{
    Guid Id;
    string Name;
}
```

---

### ➕ Создание роли

```text
Создание роли
───────────────
Название: [ AUDITOR ]

[ Создать ]
[ Отмена ]
```

### 🧾 Команда

```csharp
CreateRoleCommand
{
    string Name;
}
```

---

### 🔒 Ограничения доступа (обязательно)

### Backend

* Все `Users / Roles` handlers:

```csharp
[Authorize(Roles = "ADMIN")]
```

### Frontend

* Flyout «Администрирование»:

  * отображается **только если role == ADMIN**

---
