<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="MyFactory.MauiClient.Pages.Reference.Workshops.WorkshopExpensesTablePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:converters="clr-namespace:MyFactory.MauiClient.Converters"
    xmlns:models="clr-namespace:MyFactory.MauiClient.Models.WorkshopExpenses"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:view_model="clr-namespace:MyFactory.MauiClient.ViewModels.Reference.Workshops"
    x:DataType="view_model:WorkshopExpensesTablePageViewModel"
    Title="Цеховые расходы">

    <ContentPage.Resources>
        <converters:DecimalToCurrencyConverter x:Key="DecimalToCurrencyConverter" />
        <Style x:Key="ExpenseBorderStyle" TargetType="Border">
            <Setter Property="Stroke" Value="{AppThemeBinding Light=#E5E7EB, Dark=#374151}" />
            <Setter Property="Background" Value="{AppThemeBinding Light=#FFFFFF, Dark=#1F2937}" />
            <Setter Property="StrokeShape">
                <Setter.Value>
                    <RoundRectangle CornerRadius="12" />
                </Setter.Value>
            </Setter>
            <Setter Property="Padding" Value="16" />
            <Setter Property="Margin" Value="16,8" />
        </Style>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="+" Command="{Binding CreateNewCommand}" Priority="0" Order="Primary" />
    </ContentPage.ToolbarItems>

    <RefreshView Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsBusy}">
        <CollectionView ItemsSource="{Binding Expenses}" SelectionMode="None">
            <CollectionView.EmptyView>
                <Label
                    HorizontalOptions="Center"
                    Text="Расходы не найдены"
                    TextColor="{AppThemeBinding Light=#6B7280, Dark=#9CA3AF}" />
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:WorkshopExpenseListResponse">
                    <Border Style="{StaticResource ExpenseBorderStyle}">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Label FontAttributes="Bold" FontSize="16" Text="{Binding Workshop}" />
                            <Label
                                Grid.Column="1"
                                FontAttributes="Bold"
                                Text="{Binding AmountPerUnit, Converter={StaticResource DecimalToCurrencyConverter}, ConverterParameter='/ед.'}"
                                HorizontalTextAlignment="End" />

                            <Label Grid.Row="1" Text="Период" TextColor="#6B7280" />
                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" HorizontalOptions="End" Spacing="4">
                                <Label Text="{Binding EffectiveFrom, StringFormat='{}{0:d}'}" />
                                <Label Text="—" />
                                <Label Text="{Binding EffectiveTo, StringFormat='{}{0:d}'}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding EffectiveTo}" Value="{x:Null}">
                                            <Setter Property="Text" Value="по наст. время" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </HorizontalStackLayout>
                            <Label Grid.Row="2" Grid.ColumnSpan="2" Text="{Binding Id}" FontSize="12" TextColor="#9CA3AF" />
                        </Grid>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenCardCommand}"
                                CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </RefreshView>
</ContentPage>
