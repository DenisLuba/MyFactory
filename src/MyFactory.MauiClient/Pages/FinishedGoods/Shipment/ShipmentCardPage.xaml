<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="MyFactory.MauiClient.Pages.FinishedGoods.Shipment.ShipmentCardPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:MyFactory.MauiClient.Converters"
    xmlns:models="clr-namespace:MyFactory.MauiClient.Models.Shipments"
    xmlns:view_model="clr-namespace:MyFactory.MauiClient.ViewModels.FinishedGoods.Shipment"
    x:DataType="view_model:ShipmentCardPageViewModel"
    Title="Карточка отгрузки">

    <ContentPage.Resources>
        <Color x:Key="SecondaryTextColor">#6B7280</Color>
        <Style x:Key="CaptionLabel" TargetType="Label">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="TextColor" Value="{StaticResource SecondaryTextColor}" />
        </Style>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <RefreshView Command="{Binding LoadShipmentCommand}" IsRefreshing="{Binding IsBusy}">
        <ScrollView>
            <VerticalStackLayout Padding="16" Spacing="16">
                <HorizontalStackLayout Spacing="12">
                    <Label FontAttributes="Bold" FontSize="20" Text="Отгрузка" />
                    <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />
                </HorizontalStackLayout>

                <ContentPresenter x:Name="ShipmentDetails" Content="{Binding Shipment}" IsVisible="True">
                    <ContentPresenter.Triggers>
                        <DataTrigger TargetType="ContentPresenter" Binding="{Binding Shipment}" Value="{x:Null}">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </ContentPresenter.Triggers>
                    <ContentPresenter.ContentTemplate>
                        <DataTemplate x:DataType="models:ShipmentCardResponse">
                            <VerticalStackLayout Spacing="16">
                                <Frame CornerRadius="12" HasShadow="False" BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F2937}">
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="8">
                                        <Label FontAttributes="Bold" FontSize="18" Text="{Binding Customer}" />
                                        <Label Grid.Column="1" HorizontalTextAlignment="End" Text="{Binding Date, StringFormat='{}{0:dd.MM.yyyy}'}" />

                                        <Label Grid.Row="1" Style="{StaticResource CaptionLabel}" Text="{Binding Status, StringFormat='Статус: {0}'}" />
                                        <Label
                                            Grid.Row="1"
                                            Grid.Column="1"
                                            FontAttributes="Bold"
                                            HorizontalTextAlignment="End"
                                            Text="{Binding TotalAmount, StringFormat='Итого: {0:N0} ₽'}" />
                                    </Grid>
                                </Frame>

                                <Label FontAttributes="Bold" Text="Позиции" />

                                <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ShipmentItemDto">
                                            <Grid ColumnDefinitions="2*,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="4" Padding="0,8">
                                                <Label FontAttributes="Bold" Text="{Binding ProductName}" />
                                                <Label Grid.Column="1" Text="{Binding Qty, StringFormat='Кол-во: {0}'}" />
                                                <Label Grid.Column="2" Text="{Binding UnitPrice, StringFormat='Цена: {0:N2} ₽'}" />
                                                <Label Grid.Column="3" Text="{Binding LineTotal, StringFormat='Сумма: {0:N0} ₽'}" HorizontalTextAlignment="End" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <Button
                                    Text="Подтвердить оплату"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ConfirmPaymentCommand}"
                                    IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CanConfirmPayment}"
                                    IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsConfirmingPayment, Converter={StaticResource InvertedBoolConverter}}" />
                            </VerticalStackLayout>
                        </DataTemplate>
                    </ContentPresenter.ContentTemplate>
                </ContentPresenter>

                <Label
                    Text="Данные отгрузки не найдены"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    IsVisible="False">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label" Binding="{Binding Shipment}" Value="{x:Null}">
                            <Setter Property="IsVisible" Value="True" />
                        </DataTrigger>
                    </Label.Triggers>
                </Label>
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
