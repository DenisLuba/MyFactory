<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="MyFactory.MauiClient.Pages.FinishedGoods.Shipment.ShipmentsTablePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:MyFactory.MauiClient.Converters"
    xmlns:ui="clr-namespace:MyFactory.MauiClient.UIModels.FinishedGoods"
    xmlns:view_model="clr-namespace:MyFactory.MauiClient.ViewModels.FinishedGoods.Shipment"
    x:DataType="view_model:ShipmentsTablePageViewModel"
    Title="Отгрузки">

    <ContentPage.Resources>
        <Color x:Key="PrimaryColor">#2563EB</Color>
        <Color x:Key="SecondaryTextColor">#6B7280</Color>

        <Style x:Key="CardFrameStyle" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#FFFFFF, Dark=#1F2937}" />
            <Setter Property="BorderColor" Value="{AppThemeBinding Light=#E5E7EB, Dark=#374151}" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="HasShadow" Value="False" />
            <Setter Property="Padding" Value="14" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <Style x:Key="CaptionLabel" TargetType="Label">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="TextColor" Value="{StaticResource SecondaryTextColor}" />
        </Style>

        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="+" Priority="0" Order="Primary" Command="{Binding CreateShipmentCommand}" />
    </ContentPage.ToolbarItems>

    <Grid Padding="16" RowDefinitions="Auto,Auto,*" RowSpacing="12">
        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
            <Label FontAttributes="Bold" FontSize="18" Text="Документы отгрузки" VerticalOptions="Center" />
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" VerticalOptions="Center" />
            <Button
                Command="{Binding RefreshCommand}"
                HorizontalOptions="EndAndExpand"
                IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                Text="Обновить" />
        </HorizontalStackLayout>

        <Frame Grid.Row="1" Padding="14" CornerRadius="12" HasShadow="False" BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#111827}">
            <VerticalStackLayout Spacing="8">
                <Label FontAttributes="Bold" Text="Фильтры" />

                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <Entry Placeholder="Клиент" Text="{Binding CustomerFilter}" />
                    <Button Grid.Column="1" Text="Сбросить" Command="{Binding ClearFiltersCommand}" />
                </Grid>

                <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="12">
                    <Picker
                        ItemsSource="{Binding AvailableStatuses}"
                        ItemDisplayBinding="{Binding .}"
                        SelectedItem="{Binding StatusFilter}"
                        Title="Статус" />

                    <DatePicker Grid.Column="1" Date="{Binding DateFilter}" />

                    <StackLayout Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalOptions="Center">
                        <CheckBox IsChecked="{Binding IsDateFilterActive}" />
                        <Label Text="По дате" VerticalOptions="Center" />
                    </StackLayout>
                </Grid>
            </VerticalStackLayout>
        </Frame>

        <RefreshView Grid.Row="2" Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsBusy}">
            <CollectionView ItemsSource="{Binding Shipments}" SelectionMode="None">
                <CollectionView.EmptyView>
                    <Label
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        Padding="24"
                        Text="Нет отгрузок"
                        TextColor="{StaticResource SecondaryTextColor}" />
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="ui:ShipmentListItem">
                        <Frame Style="{StaticResource CardFrameStyle}">
                            <Grid ColumnDefinitions="2*,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="6">
                                <Label FontAttributes="Bold" Text="{Binding Customer}" />
                                <Label Grid.Column="1" Text="{Binding ProductName}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="Bold"
                                    HorizontalTextAlignment="End"
                                    Text="{Binding TotalAmount, StringFormat='{}{0:N0} ₽'}" />

                                <StackLayout Grid.Row="1" Orientation="Horizontal" Spacing="12">
                                    <Label Style="{StaticResource CaptionLabel}" Text="{Binding Date, StringFormat='{}{0:dd.MM.yyyy}'}" />
                                    <Label Style="{StaticResource CaptionLabel}" Text="{Binding Quantity, StringFormat='Кол-во: {0}'}" />
                                </StackLayout>

                                <Label
                                    Grid.Row="1"
                                    Grid.Column="2"
                                    HorizontalTextAlignment="End"
                                    Text="{Binding Status}"
                                    TextColor="{StaticResource PrimaryColor}" />
                            </Grid>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenShipmentCommand}"
                                    CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>
